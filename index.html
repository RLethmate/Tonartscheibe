<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harmony Wheel - V46 (Mystic Edition)</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Gochi+Hand&display=swap" rel="stylesheet">

    <style>
        /* --- BASICS --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Patrick Hand', cursive; display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; margin: 0; background-color: #f4f1ea; overflow-y: auto; 
            user-select: none; -webkit-user-select: none; padding-bottom: 100px;
        }
        h1 { margin: 5px 0; color: #333; font-size: 1.5rem; }

        /* --- START OVERLAY (LEGEND) - DARK MODE --- */
        #startOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #1a2a3a; color: #fff; z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px; overflow-y: auto;
        }
        #startOverlay h1 { color: #fff; } 
        #startOverlay p { color: #ccc !important; }

        .legend-grid {
            display: grid; grid-template-columns: 60px 1fr; gap: 10px; text-align: left; margin: 20px 0; max-width: 500px;
        }
        .legend-icon { display: flex; justify-content: center; align-items: center; }
        .legend-icon img { width: 45px; height: 45px; object-fit: contain; }
        
/* FIX: 3-Column Grid for perfect alignment */
        .legend-grid {
            display: grid; 
            /* Spalte 1: Icon (50px) | Spalte 2: Titel (Auto) | Spalte 3: Text (Rest) */
            grid-template-columns: 50px auto 1fr; 
            gap: 15px 20px; /* Vertikaler Abstand 15px, Horizontaler Abstand 20px */
            text-align: left; 
            margin: 20px 0; 
            max-width: 650px;
            align-items: center; /* Alles vertikal zentriert */
        }

        .legend-icon { display: flex; justify-content: center; align-items: center; }
        .legend-icon img { width: 45px; height: 45px; object-fit: contain; }
        
        /* NEU: Style f√ºr Titel (Fett) */
        .legend-title { 
            font-size: 1.2rem; 
            font-weight: bold; 
            color: #fff; 
            line-height: 1.2;
        }
        
        /* NEU: Style f√ºr Beschreibung (Normal) */
        .legend-desc { 
            font-size: 1.1rem; 
            color: #ddd; 
            line-height: 1.3; 
        }
        

        
        #startBtn {
            padding: 15px 50px; font-size: 1.5rem; background: #ffeb3b; color: #333; 
            border: none; border-radius: 50px; cursor: pointer; margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); font-family: 'Patrick Hand', cursive; font-weight: bold;
        }

/* --- INFO BUTTON --- */
        #infoBtn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: #fff;
            border: 2px solid #ccc;
            border-radius: 50%;
            color: #555;
            font-family: sans-serif; /* Ein einfaches "i" sieht in Sans-Serif oft besser aus als in Handschrift */
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 5000; /* Hoch genug, aber unter dem Overlay (9999) */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        #infoBtn:hover {
            background: #eee;
            border-color: #999;
            transform: scale(1.1);
        }




        /* --- INFO BAR --- */
        .info-bar {
            min-height: 50px; margin-bottom: 5px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: #222; color: #fff; width: 96%; max-width: 400px;
            border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 5px 10px;
            text-align: center; line-height: 1.1; border: 1px solid #444; flex-shrink: 0;
        }
        .info-title { font-size: 1.2rem; font-weight: bold; color: #ffeb3b; }
        .info-desc { font-size: 0.9rem; color: #ddd; font-family: sans-serif; letter-spacing: 0.3px; }

        /* --- SETTINGS --- */
        .settings-panel {
            background: #fff; padding: 5px 10px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 5px;
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px; border: 1px solid #ccc; z-index: 100; max-width: 400px; width: 96%; flex-shrink: 0;
        }
        .toggle-group { display: flex; align-items: center; gap: 4px; font-size: 0.9rem; color: #555; }
        .mode-label { display: flex; flex-direction: column; align-items: center; line-height: 0.8; font-size: 0.65rem; }
        .divider { width: 1px; background-color: #ddd; height: 20px; }
        .switch { position: relative; display: inline-block; width: 32px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-switch {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px;
        }
        .slider-switch:before {
            position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider-switch { background-color: #333; }
        input:checked + .slider-switch:before { transform: translateX(14px); }
        #tonalityToggle:checked + .slider-switch { background-color: #1a2a3a; }
        
        .threshold-group { display: flex; align-items: center; transition: opacity 0.3s; }
        input[type=range] { width: 50px; accent-color: #333; cursor: pointer; }
        input[type=range]:disabled { cursor: not-allowed; opacity: 0.5; }

        /* --- WHEEL CONTAINER --- */
        .wheel-container { 
            position: relative; width: 96vw; height: 96vw; max-width: 380px; max-height: 380px;
            touch-action: none; margin-bottom: 5px; flex-shrink: 0; 
        }
        .connections-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 4; pointer-events: none; }
        
        .conn-path { fill: none; stroke-linecap: round; opacity: 0; animation: fadeInPath 0.4s forwards; filter: drop-shadow(0 0 2px rgba(0,0,0,0.5)); }
        @keyframes fadeInPath { to { opacity: 0.8; } }

        .disc { position: absolute; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; justify-content: center; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .outer-disc { width: 100%; height: 100%; background-color: #fff; z-index: 1; border: 1px solid #999; cursor: grab; }
        .outer-disc:active { cursor: grabbing; }
        .inner-disc { width: 82%; height: 82%; background-color: #2b2b2b; color: #fff; z-index: 2; border: 2px solid #fff; pointer-events: none; transition: background-color 0.5s ease; }
        .inner-disc.minor-mode { background-color: #1a2a3a; border-color: #a0e6ff; }

        .center-hub {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 18%; height: 18%; 
            background-color: #fff; border-radius: 50%; z-index: 10; border: 3px solid #333; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1); pointer-events: auto; cursor: pointer; transition: transform 0.1s;
        }
        .center-hub:active { transform: translate(-50%, -50%) scale(0.95); }
        .center-label { font-size: 0.7rem; color: #666; pointer-events: none; margin-bottom:-2px;}
        .center-key { font-size: 1.5rem; font-weight: bold; color: #333; line-height: 1; pointer-events: none;}

        .segment-group { position: absolute; width: 40px; height: 50%; top: 0; left: 50%; margin-left: -20px; transform-origin: bottom center; pointer-events: none; z-index: 5; transition: transform 0.1s; }
        .segment-group.active .pos-roman, .segment-group.active .pos-icon { transform: scale(1.3); filter: brightness(2.0) drop-shadow(0 0 8px #fff); transition: all 0.1s ease-out; }
        
        .counter-rotator { position: absolute; width: 40px; display: flex; justify-content: center; align-items: center; pointer-events: auto; cursor: pointer; transition: transform 0.3s; }
        .outer-segment { position: absolute; width: 50px; height: 50%; top: 0; left: 50%; margin-left: -25px; transform-origin: bottom center; pointer-events: none; }
        .outer-rotator { position: absolute; width: 50px; display: flex; justify-content: center; align-items: center; pointer-events: none; }

        .pos-note { top: 4%; height: 30px; }
        .note-text { font-size: 1.5rem; font-weight: bold; color: #333; }
        .pos-roman { top: 5%; height: 35px; flex-direction: column; }
        .roman-text { font-size: 1.5rem; font-weight: bold; line-height: 1; transition: color 0.3s; }
        .quality-text { font-size: 0.8rem; opacity: 0.9; margin-top: -3px; transition: color 0.3s; }
        
 
        /* √Ñnderung: top von 22% auf 32% erh√∂ht, damit die Icons nicht den Text √ºberlagern */
        .pos-icon { top: 28%; height: 50px; } 
        
        .icon-img { max-width: 45px; max-height: 45px; width: auto; height: auto; object-fit: contain; display: block; transition: filter 0.3s; }
        .marker { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); z-index: 10; width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent; border-top: 15px solid #d32f2f; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }


        
        /* --- DASHBOARD --- */
        .dashboard {
            width: 96%; max-width: 400px; background: #fff; border: 1px solid #ccc; border-radius: 10px; margin-bottom: 5px;
            display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); flex-shrink: 0;
        }
        .viz-container { display: flex; height: 110px; } 
        .viz-part { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .viz-part.notation { flex: 0.4; background-color: #fffcf5; }
        .viz-part.instrument { flex: 0.6; }
        .viz-divider { width: 1px; background: #eee; }

        #notationSvg { width: 100%; height: 100%; overflow: visible; }
        .staff-line { stroke: #222; stroke-width: 1.5; stroke-linecap: round; opacity: 0.8; }
        .staff-line.ledger { opacity: 0.6; stroke-width: 1.5; }
        .jazz-note { fill: #111; transform-box: fill-box; transform-origin: center; transform: rotate(-15deg); }
        .jazz-stem { stroke: #111; stroke-width: 2.5; stroke-linecap: round; }
        .clef { font-family: 'Gochi Hand', cursive; font-size: 90px; fill: #111; }
        .accidental { font-family: 'Gochi Hand', cursive; font-size: 22px; fill: #111; font-weight: bold; }
        .octave-marker { font-family: 'Gochi Hand', cursive; font-size: 14px; fill: #444; font-style: italic; }
        .octave-line { stroke: #444; stroke-width: 1; stroke-dasharray: 4,4; }
        .instrument-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 2px; font-family: 'Patrick Hand', cursive; color: #333; }

        .chord-chart { width: 80px; height: 95px; display: flex; flex-direction: column; align-items: center; }
        .chart-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 2px; }
        .chart-grid { position: relative; width: 60px; height: 65px; border-top: 4px solid #222; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; }
        .chart-grid.fret { border-top: 2px solid #222; }
        .chart-string { position: relative; width: 1px; height: 100%; display: flex; justify-content: center; }
        .chart-string::after { content: ''; position: absolute; top: 0; bottom: 0; width: 1px; background: #222; }
        .chart-fret-line { position: absolute; left: 0; right: 0; height: 1px; background: #222; z-index:0; }
        .chart-dot { position: absolute; width: 11px; height: 11px; background: #111; border-radius: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2; }
        
        .chart-dot.root { background: #ff6b6b; box-shadow: 0 0 3px rgba(0,0,0,0.4); } 
        .chart-marker { position: absolute; top: -14px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #222; font-weight: bold; }
        .fret-offset-label { position: absolute; top: 0; left: -22px; font-size: 0.9rem; font-weight: bold; }

        .piano-container { display: flex; flex-direction: column; align-items: center; width: 100%; justify-content: center; }
        .piano-keys { display: flex; height: 65px; position: relative; margin-top: 5px; }
        .key { border: 1px solid #555; border-top: none; border-radius: 0 0 3px 3px; position: relative; }
        .key.white { width: 16px; background: #fff; height: 100%; z-index: 1; }
        .key.black { width: 10px; background: #333; height: 60%; margin-left: -5px; margin-right: -5px; z-index: 2; }
        .key.active { background: #fbc02d !important; border-bottom: 3px solid #f57f17; } 
        .key.root { background: #ff6b6b !important; border-bottom: 3px solid #d32f2f; } 

        /* PROGRESSION CONTAINER */
        .progression-container { width: 96%; max-width: 400px; padding: 0 5px 20px 5px; display: flex; flex-direction: column; gap: 6px; }
        
        /* SEARCH BAR */
        .search-wrapper { position: relative; width: 100%; margin-bottom: 5px; }
        .search-input {
            width: 100%; padding: 10px 40px 10px 40px; 
            font-family: 'Patrick Hand', cursive; font-size: 1.1rem;
            border: 2px solid #ccc; border-radius: 25px; outline: none;
            background: #fff; transition: all 0.3s;
        }
        .search-input:focus { border-color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; color: #888; }
        
        .clear-icon {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            font-size: 1.1rem; color: #999; cursor: pointer;
            width: 24px; height: 24px; line-height: 24px; text-align: center;
            border-radius: 50%; background: #eee; display: none;
        }

        /* REPLAY CARD */
        .replay-card {
            background: #fff9c4; border: 1px solid #fbc02d; border-radius: 10px; padding: 10px;
            margin-bottom: 10px; text-align: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
        .replay-title { font-weight: bold; font-size: 1.1rem; color: #333; }
        .replay-hint { font-size: 0.8rem; color: #666; }

        .prog-btn {
            background: white; border: 1px solid #ccc; border-radius: 8px; padding: 8px 12px; 
            text-align: left; cursor: pointer; transition: background 0.2s; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; 
            align-items: center; min-height: 60px; /* Increased height */
        }
        .prog-btn:hover { background: #f9f9f9; border-color: #999; }
        .prog-btn.playing { border-color: #333; background: #eee; cursor: wait;}
        .prog-info { display: flex; flex-direction: column; justify-content: center; }
        .prog-title { font-weight: bold; font-size: 0.95rem; color: #333; }
        .prog-steps { font-size: 0.8rem; color: #444; font-family: sans-serif; }
        .prog-ex { font-size: 0.75rem; color: #888; font-style: italic; margin-top: 2px; }
    </style>
</head>
<body>
    <div id="startOverlay">
        <h1 style="font-size:2.5rem; margin-bottom:10px;">Harmony Wheel</h1>
        <p style="font-size:1.1rem; color:#666; margin-bottom:20px; text-align:center;">
            Erforsche Akkorde und ihre Beziehung intuitiv!
        </p>
        
        <div class="legend-grid">
            
            <div class="legend-icon"><img src="haus.png" alt="Haus"></div>
            <div class="legend-title">Das Zuhause<br>(Tonika):</div>
            <div class="legend-desc">Hier startet der Song und hier endet er meistens. Ein Ort der Ruhe.</div>
            
            <div class="legend-icon"><img src="bruecke.png" alt="Br√ºcke"></div>
            <div class="legend-title">Die Br√ºcke:</div>
            <div class="legend-desc">F√ºhrt uns weg vom Zuhause hin zu spannenderen Orten.</div>
            
            <div class="legend-icon"><img src="berg_klein.png" alt="Kleiner Berg"></div>
            <div class="legend-title">Kleiner Berg <br>(Subdominante):</div>
            <div class="legend-desc">Ein sch√∂ner Ausflug, weg vom Alltag mit kleinem Zug nach Hause oder woanders hin.</div>
            
            <div class="legend-icon"><img src="berg_gross.png" alt="Gro√üer Berg"></div>
            <div class="legend-title">Gro√üer Berg <br>(Dominante):</div>
            <div class="legend-desc">Maximale Spannung mit viel Heimweh! Von hier aus will man meist wieder nach Hause.</div>
        </div>
        <button id="startBtn">Starten ‚ñ∂</button>
        <p style="font-size:0.8rem; color:#888; margin-top:20px;">(Stummschalter deaktivieren)</p>
    </div>
    <div id="infoBtn" onclick="showStartScreen()">i</div>

    <h1>Harmony Wheel</h1>

    <div class="info-bar" id="infoBar">
        <div class="info-title">Willkommen!</div>
        <div class="info-desc">Drehe die Tonartscheibe und klicke auf ein Symbol.</div>
    </div>

    <div class="settings-panel">
        <div class="toggle-group">
            <span class="mode-label">‚òÄ</span>
            <label class="switch"><input type="checkbox" id="tonalityToggle" onchange="updateUI()"><span class="slider-switch"></span></label>
            <span class="mode-label">üåô</span>
        </div>
        <div class="divider"></div>
        <div class="toggle-group">
            <span>Pop</span><label class="switch"><input type="checkbox" id="jazzToggle" onchange="updateUI()"><span class="slider-switch"></span></label><span>Jazz</span>
        </div>
        <div class="divider"></div>
        <div class="toggle-group">
            <span>üéπ</span><label class="switch"><input type="checkbox" id="guitarToggle" onchange="updateInstrumentDisplay()"><span class="slider-switch"></span></label><span>üé∏</span>
        </div>
        <div class="divider"></div>
        <div class="toggle-group">
            <span>‚òä</span><label class="switch"><input type="checkbox" id="pathToggle" onclick="togglePathLines()"><span class="slider-switch"></span></label>
        </div>
        <div class="threshold-group" id="sliderContainer">
            <input type="range" id="complexitySlider" min="1" max="3" value="2" step="1" oninput="redrawLines()">
        </div>
    </div>

    <div class="wheel-container" id="wheelContainer">
        <div class="marker"></div>
        <svg class="connections-layer" id="connLayer"><defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs></svg>
        <div class="disc outer-disc" id="outerWheel"></div>
        <div class="disc inner-disc" id="innerWheel"></div>
        <div class="center-hub" onclick="playKeyCenter()"><span class="center-label">Tonart</span><span class="center-key" id="keyDisplay">C</span></div>
    </div>

    <div class="dashboard">
        <div class="viz-container">
            <div class="viz-part notation">
                <svg id="notationSvg" viewBox="0 0 160 120">
                </svg>
            </div>
            <div class="viz-divider"></div>
            <div class="viz-part" id="instrumentContainer"></div>
        </div>
    </div>

    <div class="progression-container">
        <div class="search-wrapper">
            <span class="search-icon">üîç</span>
            <input type="text" id="songSearch" class="search-input" placeholder="Song suchen..." onfocus="showAllSongs()" oninput="filterSongs()">
            <span class="clear-icon" id="clearBtn" onclick="clearSearch()">‚úñ</span>
        </div>
        <div id="replayArea"></div>
        <div id="progList"></div>
    </div>

    <script>
        function safeMod(n, m) { return ((n % m) + m) % m; }
        function wait(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "H"];
        const enharmonicMap = { "C#": "Db", "D#": "Eb", "F#": "Gb", "G#": "Ab", "A#": "Bb", "Db": "C#", "Eb": "D#", "Gb": "F#", "Ab": "G#", "Bb": "A#" };
        const noteIndexMap = {}; notes.forEach((n,i) => noteIndexMap[n] = i);
        const guitarBaseStrings = [4, 9, 2, 7, 11, 4];

        // Standard Guitar Chords
// Standard Guitar Chords (Extended with m7)
        const guitarChordLibrary = {
            // C
            "C": [-1, 3, 2, 0, 1, 0], "Cm": [-1, 3, 5, 5, 4, 3], "Cmaj7": [-1, 3, 2, 0, 0, 0], "C7": [-1, 3, 2, 3, 1, 0],
            "Cm7": [-1, 3, 5, 3, 4, 3], // Barre 3
            // Db / C#
            "Db": [-1, 4, 6, 6, 6, 4], "Dbm": [-1, 4, 6, 6, 5, 4], "Dbmaj7": [-1, 4, 6, 5, 6, 4], "Db7": [-1, 4, 6, 4, 6, 4],
            "Dbm7": [-1, 4, 6, 4, 5, 4], "C#m7": [-1, 4, 6, 4, 5, 4],
            // D
            "D": [-1, -1, 0, 2, 3, 2], "Dm": [-1, -1, 0, 2, 3, 1], "Dmaj7": [-1, -1, 0, 2, 2, 2], "D7": [-1, -1, 0, 2, 1, 2],
            "Dm7": [-1, -1, 0, 2, 1, 1], 
            // Eb / D#
            "Eb": [-1, 6, 8, 8, 8, 6], "Ebm": [-1, 6, 8, 8, 7, 6], "Ebmaj7": [-1, 6, 8, 7, 8, 6], "Eb7": [-1, 6, 8, 6, 8, 6],
            "Ebm7": [-1, 6, 8, 6, 7, 6], "D#m7": [-1, 6, 8, 6, 7, 6],
            // E
            "E": [0, 2, 2, 1, 0, 0], "Em": [0, 2, 2, 0, 0, 0], "Emaj7": [0, 2, 1, 1, 0, 0], "E7": [0, 2, 0, 1, 0, 0],
            "Em7": [0, 2, 2, 0, 3, 0], 
            // F
            "F": [1, 3, 3, 2, 1, 1], "Fm": [1, 3, 3, 1, 1, 1], "Fmaj7": [-1, -1, 3, 2, 1, 0], "F7": [1, 3, 1, 2, 1, 1],
            "Fm7": [1, 3, 1, 1, 1, 1],
            // Gb / F#
            "Gb": [2, 4, 4, 3, 2, 2], "Gbm": [2, 4, 4, 2, 2, 2], "Gbmaj7": [2, -1, 3, 3, 2, -1], "Gb7": [2, 4, 2, 3, 2, 2],
            "Gbm7": [2, 4, 2, 2, 2, 2], "F#m7": [2, 4, 2, 2, 2, 2],
            // G
            "G": [3, 2, 0, 0, 0, 3], "Gm": [3, 5, 5, 3, 3, 3], "Gmaj7": [3, 2, 0, 0, 0, 2], "G7": [3, 2, 0, 0, 0, 1],
            "Gm7": [3, 5, 3, 3, 3, 3],
            // Ab / G#
            "Ab": [4, 6, 6, 5, 4, 4], "Abm": [4, 6, 6, 4, 4, 4], "Abmaj7": [4, -1, 5, 5, 4, -1], "Ab7": [4, 6, 4, 5, 4, 4],
            "Abm7": [4, 6, 4, 4, 4, 4], "G#m7": [4, 6, 4, 4, 4, 4],
            // A
            "A": [-1, 0, 2, 2, 2, 0], "Am": [-1, 0, 2, 2, 1, 0], "Amaj7": [-1, 0, 2, 1, 2, 0], "A7": [-1, 0, 2, 0, 2, 0],
            "Am7": [-1, 0, 2, 0, 1, 0],
            // Bb / A#
            "Bb": [-1, 1, 3, 3, 3, 1], "Bbm": [-1, 1, 3, 3, 2, 1], "Bbmaj7": [-1, 1, 3, 2, 3, 1], "Bb7": [-1, 1, 3, 1, 3, 1],
            "Bbm7": [-1, 1, 3, 1, 2, 1], "A#m7": [-1, 1, 3, 1, 2, 1],
            // H / B
            "H": [-1, 2, 4, 4, 4, 2], "Hm": [-1, 2, 4, 4, 3, 2], "Hmaj7": [-1, 2, 4, 3, 4, 2], "H7": [-1, 2, 1, 2, 0, 2],
            "Hm7": [-1, 2, 4, 2, 3, 2], "Bm7": [-1, 2, 4, 2, 3, 2] // Bm7 often used for H
        };

        const colorsMajor = { tonic: "#C1E1C1", subdom: "#FDFD96", dom: "#FFB7B2", minor: "#B5EAD7", dim: "#D3D3D3" };
        
        const colorsMinor = { 
            tonic: "#6495ED", // Burg (CornflowerBlue)
            tonicParallel: "#90EE90", // Lichtung (LightGreen)
            subdom: "#48D1CC", // Nebelwald (MediumTurquoise)
            subdomParallel: "#5F9EA0", // Ruine/Sturm (CadetBlue)
            dom: "#9370DB", // Drache (MediumPurple)
            dim: "#B0C4DE" // Sumpf (LightSteelBlue)
        };

        // FIX: Swapped Nebelwald (now bIII) and Lichtung (now iv) based on request
        const wheelPositions = [
            { index: 0, 
              major: { roman: "I", desc: "Zuhause. Der Ruhepol (Tonika).", emoji: "üè†", image: "haus.png", color: colorsMajor.tonic, interval: 0, jazz: {label: "maj7", ivs:[0,4,7,11]}, pop: {label: "Dur", ivs:[0,4,7]} },
              minor: { roman: "bIII", desc: "Der Nebelwald. Geheimnisvoll.", emoji: "üå≤", image: "nebelwald.png", color: colorsMinor.subdom, interval: 0, jazz: {label: "maj7", ivs:[0,4,7,11]}, pop: {label: "Dur", ivs:[0,4,7]} } },
            null,
            { index: 2, 
              major: { roman: "II", desc: "Die Br√ºcke zur Spannung (IV oder V).", emoji: "üåâ", image: "bruecke.png", color: colorsMajor.minor, interval: 2, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} },
              minor: { roman: "iv", desc: "Die Lichtung. Ein Ort der Hoffnung.", emoji: "üå≥", image: "lichtung.png", color: colorsMinor.tonicParallel, interval: 2, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} } },
            null,
            { index: 4, 
              major: { roman: "III", desc: "Kurze Rast vor der Haust√ºr (Tonika-Parallele).", emoji: "üå≥", image: "bank.png", color: colorsMajor.minor, interval: 4, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} },
              minor: { roman: "V", desc: "Der Drache! Magisch und gef√§hrlich.", emoji: "üê≤", image: "drache.png", color: colorsMinor.dom, interval: 4, jazz: {label: "7(b9)", ivs:[0,4,7,10]}, pop: {label: "Dur", ivs:[0,4,7]} } },
            { index: 5, 
              major: { roman: "IV", desc: "Kleiner Berg. Aufbruch (Sub-Dominante).", emoji: "‚õ∞Ô∏è", image: "berg_klein.png", color: colorsMajor.subdom, interval: 5, jazz: {label: "maj7", ivs:[0,4,7,11]}, pop: {label: "Dur", ivs:[0,4,7]} },
              minor: { roman: "bVI", desc: "Sturm an der K√ºste. Dramatisch.", emoji: "‚õàÔ∏è", image: "sturm.png", color: colorsMinor.subdomParallel, interval: 5, jazz: {label: "maj7", ivs:[0,4,7,11]}, pop: {label: "Dur", ivs:[0,4,7]} } },
            null,
            { index: 7, 
              major: { roman: "V", desc: "Gro√üer Berg - maximale Spannung (Dominante)!", emoji: "üåã", image: "berg_gross.png", color: colorsMajor.dom, interval: 7, jazz: {label: "7", ivs:[0,4,7,10]}, pop: {label: "Dur", ivs:[0,4,7]} },
              minor: { roman: "bVII", desc: "Alte Br√ºcke - eine Verbindung zu ewas anderem.", emoji: "üåâ", image: "alte_bruecke.png", color: "#87CEEB", interval: 7, jazz: {label: "7", ivs:[0,4,7,10]}, pop: {label: "Dur", ivs:[0,4,7]} } },
            null,
            { index: 9, 
              major: { roman: "VI", desc: "Br√ºcke √ºber die Moll-Dominante. Etwas traurig.", emoji: "üåâ", image: "bruecke.png", color: colorsMajor.minor, interval: 9, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} },
              minor: { roman: "i", desc: "Die Burg. Festung und Heimat.", emoji: "üè∞", image: "burg.png", color: colorsMinor.tonic, interval: 9, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} } },
            null,
            { index: 11, 
              major: { roman: "VII", desc: "Die Klippe. Sehr instabil.", emoji: "‚ö°", image: "klippe.png", color: colorsMajor.dim, interval: 11, jazz: {label: "m7b5", ivs:[0,3,6,10]}, pop: {label: "Verm.", ivs:[0,3,6]} },
              minor: { roman: "ii¬∞", desc: "Der Sumpf. Bodenlos und tr√ºb.", emoji: "üå´Ô∏è", image: "sumpf.png", color: colorsMinor.dim, interval: 11, jazz: {label: "m7b5", ivs:[0,3,6,10]}, pop: {label: "Verm.", ivs:[0,3,6]} } } 
        ];

const probabilityMap = {
            major: {
                pop: { 
                    // I: Dominante(V), Subdominante(IV), Moll-Parallele(VI), Sekund√§rdominante(II)
                    "I":   [["V",3], ["IV",3], ["VI",2], ["II",1]], 
                    
                    // II: Will zur V. Ersatzweise zur IV. Neu: Zur VI (Trugschluss)
                    "II":  [["V",3], ["IV",2], ["VI",2]], 
                    
                    // III: Will zur VI. Ersatzweise zur IV. Neu: Zur I (als Loop-Neustart)
                    "III": [["VI",3], ["IV",2], ["I",1]], 
                    
                    // IV: Plagal zur I, oder Spannung zur V. Neu: Zur II (Bleibt Subdominante)
                    "IV":  [["I",3], ["V",3],  ["II",2], ["VI",1]], 
                    
                    // V: Authentisch zur I, Trugschluss zur VI. Neu: Zur IV (Pop-Klischee Mixolydisch)
                    "V":   [["I",3], ["VI",2], ["IV",2], ["III",1]], 
                    
                    // VI: Zur IV (Emotional), zur V. Neu: Zur II (Quintfall)
                    "VI":  [["IV",3], ["V",2],  ["II",2], ["I",1]], 
                    
                    // VII: Leitton zur I. In Pop selten, geht oft zur III oder VI.
                    "VII": [["I",3], ["III",2], ["VI",2]] 
                },
                jazz: { 
                    "I":   [["VI",3], ["IV",2], ["II",2]], 
                    "II":  [["V",3],  ["VII",1], ["I",1]], 
                    "III": [["VI",3], ["II",2],  ["IV",1]], 
                    "IV":  [["I",3],  ["VII",2], ["V",1]], 
                    "V":   [["I",3],  ["III",2], ["VI",1]], 
                    "VI":  [["II",3], ["V",2],   ["III",1]], 
                    "VII": [["III",3],["I",1],   ["VI",1]] 
                }
            },
            minor: {
                pop: { 
                    // i: Zur V (Harmonisch), zur bVI (Dramatik). Neu: zur bVII (Nat√ºrlich Moll / Rock)
                    "i":   [["bVI",3], ["bVII",3], ["V",2], ["iv",1]], 
                    
                    // iv: Plagal zur i, oder zur V. Neu: zur bVI (Trugschluss-√§hnlich)
                    "iv":  [["V",3],   ["i",2],    ["bVI",2]], 
                    
                    // V: Zur i. Trugschluss zur bVI. Neu: zur bIII (Parallel-Dur)
                    "V":   [["i",3],   ["bVI",2],  ["bIII",2]], 
                    
                    // bIII (Dur): Zur bVI (Quintfall), zur i. Neu: zur bVII (Backdoor)
                    "bIII":[["bVI",3], ["i",2],    ["bVII",2]], 
                    
                    // bVI: Zur V (Halbschluss). Neu: zur iv (Subdominant) oder bVII
                    "bVI": [["V",3],   ["bVII",2], ["iv",2]], 
                    
                    // bVII: Zur bIII (Dur-Aufl√∂sung). Neu: zur i (Rock-Kadenz) oder bVI
                    "bVII":[["bIII",3],["bVI",2],  ["i",2]], 
                    
                    // ii¬∞: Zur V (Klassisch). Neu: zur iv (Bleibt Subdominante) oder i
                    "ii¬∞": [["V",3],   ["iv",2],   ["i",1]] 
                },
                jazz: { 
                    "i":   [["iv",3],  ["bVI",2], ["ii¬∞",2]], 
                    "ii¬∞": [["V",3],   ["i",1],   ["bVII",1]], 
                    "V":   [["i",3],   ["bVI",1], ["bIII",1]], 
                    "iv":  [["bVII",2],["V",2],   ["i",1]], 
                    "bVI": [["ii¬∞",3], ["V",2],   ["bVII",1]], 
                    "bIII":[["bVI",3], ["iv",1],  ["bVII",1]], 
                    "bVII":[["bIII",3],["i",1],   ["bVI",1]] 
                }
            }
        };

        // FIX: Renamed 4-Chord Song to "Axis of Awesome"
        const progressions = {
            major: {
                pop: [ { name: "La Bamba Loop", seq: ["I", "IV", "V", "IV"], ex: "La Bamba / Wild Thing" }, { name: "Axis of Awesome", seq: ["I", "V", "VI", "IV"], ex: "Let It Be / Country Roads /An Tagen wie diesen / High Hopes" }, { name: "The Africa Loop", seq: ["VI", "IV", "I", "V"], ex: "Africa / Pokerface / Zusammen / Someone" } ],
                jazz: [ { name: "The Jazz DNA", seq: ["II", "V", "I"], ex: "Satin Doll" }, { name: "Turnaround", seq: ["I", "VI", "II", "V"], ex: "I Got Rhythm" }, { name: "Moll-Kadenz", seq: ["VII", "III", "VI"], ex: "Autumn Leaves" } ]
            },
            minor: {
                pop: [ { name: "Andalusian", seq: ["i", "bVII", "bVI", "V"], ex: "Hit the Road Jack / Sultans of Swing /Good Vibrations" }, { name: "The Zombie Loop", seq: ["i", "bVI", "bIII", "bVII"], ex: "Zombie / Apologize / Hello / Despacito" }, { name: "Minor Ballad", seq: ["i", "iv", "V", "i"], ex: "House of Rising Sun / Besame mucho / Sway" } ],
                jazz: [ { name: "Minor II-V-I", seq: ["ii¬∞", "V", "i"], ex: "Autumn Leaves" }, { name: "Minor Turnaround", seq: ["i", "bVI", "ii¬∞", "V"], ex: "Blue Bossa" }, { name: "Minor Blues", seq: ["i", "iv", "i", "V"], ex: "Mr. P.C." } ]
            }
        };

        // --- EXTENDED SONGBOOK ---
        const songDatabase = [
            // Pop Major
            { title: "Let It Be", interpret: "The Beatles", key: "C", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "No Woman No Cry", interpret: "Bob Marley", key: "C", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "I'm Yours", interpret: "Jason Mraz", key: "H", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "Don't Stop Believin'", interpret: "Journey", key: "E", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "Can You Feel The Love Tonight", interpret: "Elton John", key: "F", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "Take Me Home Country Roads", interpret: "John Denver", key: "A", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "With or Without You", interpret: "U2", key: "D", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "She Will Be Loved", interpret: "Maroon 5", key: "C", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "High Hopes", interpret: "Panic! At The Disco", key: "F", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "Beautiful Things", interpret: "Benson Boone", key: "C", type: "major", seq: ["VI", "I", "V", "IV"] },
            { title: "I Ain't Worried", interpret: "OneRepublic", key: "C", type: "major", seq: ["IV", "V", "VI", "V"] },
            { title: "Someone", interpret: "ClockClock", key: "D", type: "major", seq: ["VI", "IV", "I", "V"] },
            { title: "Stand By Me", interpret: "Ben E. King", key: "A", type: "major", seq: ["I", "VI", "IV", "V"] },
            { title: "Perfect", interpret: "Ed Sheeran", key: "G#", type: "major", seq: ["I", "VI", "IV", "V"] },
            { title: "Every Breath You Take", interpret: "The Police", key: "G#", type: "major", seq: ["I", "VI", "IV", "V"] },
            { title: "Africa", interpret: "Toto", key: "H", type: "major", seq: ["VI", "IV", "I", "V"] },
            { title: "Hallelujah", interpret: "Leonard Cohen", key: "C", type: "major", seq: ["I", "VI", "I", "VI", "IV", "V"] },
            { title: "Imagine", interpret: "John Lennon", key: "C", type: "major", seq: ["I", "IV", "I", "IV"] },
            { title: "Knockin on Heavens Door", interpret: "Bob Dylan", key: "G", type: "major", seq: ["I", "V", "II", "IV"] },
            { title: "La Bamba", interpret: "Ritchie Valens", key: "C", type: "major", seq: ["I", "IV", "V"] },
            { title: "Twist and Shout", interpret: "The Beatles", key: "D", type: "major", seq: ["I", "IV", "V"] },
            { title: "Sweet Home Alabama", interpret: "Lynyrd Skynyrd", key: "D", type: "major", seq: ["V", "IV", "I"] },
            { title: "Sweet Child O' Mine", interpret: "Guns N' Roses", key: "D", type: "major", seq: ["I", "bVII", "IV", "I"] },
            { title: "Viva La Vida", interpret: "Coldplay", key: "Ab", type: "major", seq: ["IV", "V", "I", "VI"] },
            { title: "Clocks", interpret: "Coldplay", key: "Eb", type: "major", seq: ["I", "V", "II", "IV"] },
            { title: "Hey Jude", interpret: "The Beatles", key: "F", type: "major", seq: ["I", "V", "V", "I"] },
            { title: "Yesterday", interpret: "The Beatles", key: "F", type: "major", seq: ["I", "VII", "VI", "IV", "V", "I"] },
            { title: "Purple Rain", interpret: "Prince", key: "A#", type: "major", seq: ["I", "VI", "V", "IV"] },
            { title: "Halo", interpret: "Beyonc√©", key: "A", type: "major", seq: ["I", "VI", "IV", "V"] },
            { title: "An Tagen wie diesen", interpret: "Die Toten Hosen", key: "D", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "Wannsee", interpret: "Die Toten Hosen", key: "Eb", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "Zusammen", interpret: "Fanta4", key: "C", type: "major", seq: ["VI", "IV", "I", "V"] },
            { title: "Alles nur geklaut", interpret: "Die Prinzen", key: "C", type: "major", seq: ["I", "VI", "II", "V"] },
            { title: "Something", interpret: "The Beatles", key: "C", type: "major", seq: ["I", "I", "VII", "I"] }, 
            { title: "Fly Away", interpret: "Lenny Kravitz", key: "A", type: "major", seq: ["I", "bVII", "bVI", "bVII"] },
            { title: "I Don't Wanna Wait", interpret: "David Guetta", key: "C", type: "major", seq: ["VI", "IV", "I", "V"] },
            
            // Pop Minor / Rock
            { title: "Zombie", interpret: "The Cranberries", key: "E", type: "minor", seq: ["i", "bVI", "bIII", "bVII"] },
            { title: "Hello", interpret: "Adele", key: "F", type: "minor", seq: ["i", "bVI", "bIII", "bVII"] },
            { title: "Apologize", interpret: "Timbaland/OneRepublic", key: "C", type: "minor", seq: ["i", "bVI", "bIII", "bVII"] },
            { title: "Love The Way You Lie", interpret: "Eminem/Rihanna", key: "G", type: "minor", seq: ["i", "bVI", "bIII", "bVII"] },
            { title: "Hit the Road Jack", interpret: "Ray Charles", key: "G#", type: "minor", seq: ["i", "bVII", "bVI", "V"] },
            { title: "Hotel California", interpret: "Eagles", key: "H", type: "minor", seq: ["i", "V", "bVII", "IV", "bVI", "bIII", "iv", "V"] },
            { title: "Billie Jean", interpret: "Michael Jackson", key: "F#", type: "minor", seq: ["i", "iv", "i", "iv"] },
            { title: "All of Me", interpret: "John Legend", key: "F", type: "minor", seq: ["i", "bVI", "bIII", "bVII"] },
            { title: "Radioactive", interpret: "Imagine Dragons", key: "H", type: "minor", seq: ["i", "bIII", "V", "bVI"] },
            { title: "Counting Stars", interpret: "OneRepublic", key: "C#", type: "minor", seq: ["i", "bIII", "V", "bVI"] },
            { title: "Wonderwall", interpret: "Oasis", key: "F#", type: "minor", seq: ["i", "bIII", "bVII", "IV"] },
            { title: "Smells Like Teen Spirit", interpret: "Nirvana", key: "F", type: "minor", seq: ["i", "iv", "bIII", "bVI"] },
            { title: "Otherside", interpret: "Red Hot Chili Peppers", key: "A", type: "minor", seq: ["i", "bVI", "bIII", "bVII"] },
            { title: "Boulevard of Broken Dreams", interpret: "Green Day", key: "F", type: "minor", seq: ["i", "bIII", "bVII", "V"] },
            { title: "Despacito", interpret: "Luis Fonsi", key: "H", type: "minor", seq: ["i", "bVI", "bIII", "bVII"] },
            { title: "Rolling in the Deep", interpret: "Adele", key: "C", type: "minor", seq: ["i", "bVII", "bVI", "bVII", "bVI"] },
            { title: "Bones", interpret: "Imagine Dragons", key: "F", type: "minor", seq: ["i", "bVI", "III", "i"] }, 
            { title: "Thunderstruck", interpret: "AC/DC", key: "H", type: "major", seq: ["I", "bVII", "IV", "I"] }, 
            { title: "Back in Black", interpret: "AC/DC", key: "E", type: "major", seq: ["I", "bVII", "IV"] },
            { title: "While My Guitar Gently Weeps", interpret: "The Beatles", key: "A", type: "minor", seq: ["i", "i", "iv", "bVII", "bIII", "V"] },
            { title: "Hey Joe", interpret: "Jimi Hendrix", key: "E", type: "major", seq: ["bVI", "bIII", "bVII", "IV", "I"] },
            { title: "Seven Nation Army", interpret: "The White Stripes", key: "E", type: "minor", seq: ["i", "bIII", "i", "bVII", "bVI", "V"] },
            { title: "Mad World", interpret: "Tears for Fears", key: "F", type: "minor", seq: ["i", "bIII", "bVII", "IV"] },
            { title: "Lady in Black", interpret: "Uriah Heep", key: "E", type: "minor", seq: ["i", "bVII", "i"] },
            { title: "I Will Survive", interpret: "Gloria Gaynor", key: "A", type: "minor", seq: ["i", "iv", "bVII", "bIII", "bVI", "ii¬∞", "V"] },
            { title: "The Weekend Whip", interpret: "The Fold (Ninjago)", key: "D", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "Get Lucky", interpret: "Daft Punk", key: "F#", type: "minor", seq: ["i", "bIII", "iv", "V"] },
            { title: "It Ain't Over 'til It's Over", interpret: "Lenny Kravitz", key: "Db", type: "major", seq: ["I", "VI", "I", "VI"] },
            // Neue Andalusian Examples
            { title: "Sultans of Swing", interpret: "Dire Straits", key: "Dm", type: "minor", seq: ["i", "bVII", "bVI", "V"] },
            { title: "Happy Together", interpret: "The Turtles", key: "F#", type: "minor", seq: ["i", "bVII", "bVI", "V"] },
            { title: "Stray Cat Strut", interpret: "Stray Cats", key: "C", type: "minor", seq: ["i", "bVII", "bVI", "V"] },
            { title: "Good Vibrations", interpret: "The Beach Boys", key: "Eb", type: "minor", seq: ["i", "bVII", "bVI", "V"] },
            { title: "Hazy Shade of Winter", interpret: "The Bangles", key: "D", type: "minor", seq: ["i", "bVII", "bVI", "V"] },
            { title: "Runaway", interpret: "Del Shannon", key: "Bb", type: "minor", seq: ["i", "bVII", "bVI", "V"] },

            // Neue Minor Ballad / Latin Examples
            { title: "Sway", interpret: "Michael Bubl√©", key: "Dm", type: "minor", seq: ["i", "iv", "V", "i"] },
            { title: "Black Magic Woman", interpret: "Santana", key: "Dm", type: "minor", seq: ["i", "V", "i", "iv"] }, // Oft leicht variiert, aber passt gut
            { title: "Girl, You'll Be a Woman Soon", interpret: "Urge Overkill", key: "Gm", type: "minor", seq: ["i", "V", "i", "iv"] }, 
            { title: "Besame Mucho", interpret: "Standard", key: "Dm", type: "minor", seq: ["i", "iv", "V", "i"] },
            { title: "House of the Rising Sun", interpret: "The Animals", key: "A", type: "minor", seq: ["i", "iv", "V", "i"] },
            
            // Jazz Standards
            { title: "Autumn Leaves", interpret: "Jazz Standard", key: "E", type: "minor", seq: ["ii¬∞", "V", "i", "iv", "bVII", "bIII"] },
            { title: "Fly Me To The Moon", interpret: "Frank Sinatra", key: "A", type: "minor", seq: ["i", "iv", "bVII", "bIII", "bVI", "ii¬∞", "V"] },
            { title: "Blue Bossa", interpret: "Kenny Dorham", key: "C", type: "minor", seq: ["i", "iv", "ii¬∞", "V"] },
            { title: "So What", interpret: "Miles Davis", key: "D", type: "minor", seq: ["i", "i"] },
            { title: "Take Five", interpret: "Dave Brubeck", key: "Eb", type: "minor", seq: ["i", "bV"] },
            { title: "Summertime", interpret: "Gershwin", key: "A", type: "minor", seq: ["i", "ii¬∞", "V", "i"] }
        ];

        const outerWheel = document.getElementById('outerWheel');
        const innerWheel = document.getElementById('innerWheel'); 
        const keyDisplay = document.getElementById('keyDisplay');
        const jazzToggle = document.getElementById('jazzToggle');
        const guitarToggle = document.getElementById('guitarToggle');
        const pathToggle = document.getElementById('pathToggle');
        const tonalityToggle = document.getElementById('tonalityToggle'); 
        const complexitySlider = document.getElementById('complexitySlider');
        const wheelContainer = document.getElementById('wheelContainer');
        const progContainer = document.getElementById('progContainer');
        const progList = document.getElementById('progList');
        const connLayer = document.getElementById('connLayer');
        const infoBar = document.getElementById('infoBar');
        const instrumentContainer = document.getElementById('instrumentContainer');
        const notesGroup = document.getElementById('notesGroup');
        const startOverlay = document.getElementById('startOverlay');
        const startBtn = document.getElementById('startBtn');
        const songSearch = document.getElementById('songSearch');
        const clearBtn = document.getElementById('clearBtn');
        const replayArea = document.getElementById('replayArea');
        
        const counterRotatingElements = [];
        const segmentGroups = []; 
        let currentStep = 0;        
        let isSequencerPlaying = false;
        let lastClickedRoman = null; 
        let lastPlayedNotes = [];
        let currentChordLabelForVisualizer = "";
        let currentRootNoteName = "";
        let currentPlayingSong = null;

        // --- SORT DATABASE ON INIT ---
        songDatabase.sort((a,b) => a.title.localeCompare(b.title));

        startBtn.addEventListener('click', async () => {
            initAudio();
            if (audioCtx) {
                try {
                    await audioCtx.resume();
                    const buffer = audioCtx.createBuffer(1, 1, 22050);
                    const source = audioCtx.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioCtx.destination);
                    source.start(0);
                } catch (e) { console.error(e); }
            }
            startOverlay.style.opacity = '0';
            setTimeout(() => { startOverlay.style.display = 'none'; }, 500);
            initWheel();
            setWheelRotation(0);
            updateUI();
        });

        function initWheel() {
            if(outerWheel.children.length > 0) return;
            
            notes.forEach((note, index) => {
                const segment = document.createElement('div');
                segment.className = 'outer-segment'; 
                segment.style.transform = `rotate(${index * 30}deg)`;
                const wrapper = document.createElement('div');
                wrapper.className = 'outer-rotator pos-note';
                wrapper.innerHTML = `<span class="note-text">${note}</span>`;
                segment.appendChild(wrapper);
                outerWheel.appendChild(segment);
            });

            wheelPositions.forEach((posData) => {
                if (posData) {
                    const index = posData.index;
                    const group = document.createElement('div');
                    group.className = 'segment-group';
                    group.style.transform = `rotate(${index * 30}deg)`;
                    group.dataset.index = index; 
                    const refs = { group: group, data: posData };
                    group.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        if(isSequencerPlaying) return; 
                        playChordFromPosition(posData);
                    });
                    const romanWrapper = document.createElement('div');
                    romanWrapper.className = 'counter-rotator pos-roman';
                    const romanSpan = document.createElement('span');
                    romanSpan.className = 'roman-text';
                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'quality-text';
                    romanWrapper.appendChild(romanSpan); romanWrapper.appendChild(labelSpan);
                    group.appendChild(romanWrapper); refs.romanSpan = romanSpan; refs.labelSpan = labelSpan;
                    const iconWrapper = document.createElement('div');
                    iconWrapper.className = 'counter-rotator pos-icon';
                    const iconImg = document.createElement('img');
                    iconImg.className = 'icon-img';
                    iconWrapper.appendChild(iconImg);
                    group.appendChild(iconWrapper); refs.iconImg = iconImg;
                    romanWrapper.style.transform = `rotate(${-index * 30}deg)`;
                    iconWrapper.style.transform = `rotate(${-index * 30}deg)`;
                    innerWheel.appendChild(group);
                    segmentGroups.push(refs);
                }
            });
        }

        function setWheelRotation(angle) {
            outerWheel.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
            document.querySelectorAll('.outer-rotator').forEach((el, i) => {
                el.style.transform = `rotate(${- (i * 30) - angle}deg)`;
            });
        }

        // --- DRAWING ---
        function getMidiPitch(noteObj) {
            const idx = noteIndexMap[noteObj.note.replace('#','')];
            const isSharp = noteObj.note.includes("#");
            return (noteObj.octave + 1) * 12 + idx + (isSharp ? 1 : 0);
        }

// NEU: Hilfsobjekt f√ºr korrekte Notenlinien-Position (Diatonisch)
        const diatonicMap = { "C": 0, "D": 1, "E": 2, "F": 3, "G": 4, "A": 5, "H": 6 };


        function drawNotation(playedNotes) {
            const svg = document.getElementById('notationSvg');
            svg.innerHTML = ''; // Alles l√∂schen (auch alte Linien)
            
            if (playedNotes.length === 0) {
                // Leeres Notensystem zeichnen, falls keine Noten da sind (Zentriert)
                const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
                for (let i = 40; i <= 80; i += 10) {
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", 10); line.setAttribute("x2", 150);
                    line.setAttribute("y1", i); line.setAttribute("y2", i);
                    line.setAttribute("class", "staff-line");
                    group.appendChild(line);
                }
                const clef = document.createElementNS("http://www.w3.org/2000/svg", "text");
                clef.setAttribute("x", 10); clef.setAttribute("y", 78);
                clef.setAttribute("class", "clef"); clef.textContent = "ùÑû";
                group.appendChild(clef);
                svg.appendChild(group);
                return;
            }

            const diatonicMap = { "C": 0, "D": 1, "E": 2, "F": 3, "G": 4, "A": 5, "H": 6 };

            // 1. Oktavierung berechnen (8va / 8vb)
            let avgPitch = playedNotes.reduce((acc, n) => acc + getMidiPitch(n), 0) / playedNotes.length;
            let octaveShift = 0; 
            if(avgPitch < 55) octaveShift = -1; 
            if(avgPitch > 84) octaveShift = 1;

            // 2. Noten vorberechnen (Y-Positionen ermitteln, aber noch nicht zeichnen)
            let notesData = [];
            // Kopie erstellen und sortieren
            let sortedNotes = JSON.parse(JSON.stringify(playedNotes));
            sortedNotes.sort((a,b) => getMidiPitch(a) - getMidiPitch(b));

            let minContentY = 40; // Oberste Notenlinie (Standard)
            let maxContentY = 80; // Unterste Notenlinie (Standard)

            // Berechnungsschleife
            sortedNotes.forEach(n => {
                let visualOctave = n.octave - octaveShift;
                let baseChar = n.note.charAt(0); 
                let diaVal = diatonicMap[baseChar];
                
                // Y-Position: C4 (Mitte) ist bei Y=90 (virtuell)
                let octDiff = visualOctave - 4; 
                let y = 90 - (octDiff * 35) - (diaVal * 5); 
                
                // Grenzen aktualisieren (Wo ist die h√∂chste/tiefste Note inkl. Platz f√ºr Hals?)
                if (y - 10 < minContentY) minContentY = y - 10; // Puffer oben
                if (y + 10 > maxContentY) maxContentY = y + 10; // Puffer unten

                notesData.push({ noteObj: n, y: y });
            });

            // 3. Verschiebung berechnen (Zentrierung)
            // Wir wollen, dass die Mitte des Inhalts (Noten + Linien) bei Y=60 (SVG Mitte) liegt.
            const contentCenter = (minContentY + maxContentY) / 2;
            const shiftY = 60 - contentCenter;

            // --- ZEICHNEN ---
            
            // Gruppe erstellen, die wir verschieben
            const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
            group.setAttribute("transform", `translate(0, ${shiftY})`);

            // A) Notenlinien zeichnen (40 bis 80)
            for (let i = 40; i <= 80; i += 10) {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", 10); line.setAttribute("x2", 150);
                line.setAttribute("y1", i); line.setAttribute("y2", i);
                line.setAttribute("class", "staff-line");
                group.appendChild(line);
            }

            // B) Notenschl√ºssel
            const clef = document.createElementNS("http://www.w3.org/2000/svg", "text");
            clef.setAttribute("x", 10); clef.setAttribute("y", 78);
            clef.setAttribute("class", "clef");
            clef.textContent = "ùÑû";
            group.appendChild(clef);

            // C) 8va / 8vb Marker (relativ zum System)
            if (octaveShift !== 0) {
                const markerText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                markerText.setAttribute("class", "octave-marker"); markerText.setAttribute("x", 5);
                const markerLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                markerLine.setAttribute("class", "octave-line"); markerLine.setAttribute("x1", 35); markerLine.setAttribute("x2", 130);
                if (octaveShift === -1) {
                    markerText.textContent = "8vb"; markerText.setAttribute("y", 115);
                    markerLine.setAttribute("y1", 110); markerLine.setAttribute("y2", 110);
                } else {
                    markerText.textContent = "8va"; markerText.setAttribute("y", 15);
                    markerLine.setAttribute("y1", 20); markerLine.setAttribute("y2", 20);
                }
                group.appendChild(markerText); group.appendChild(markerLine);
            }

            // D) Noten zeichnen
            let baseX = 80; 
            let prevY = -999; 

            notesData.forEach(d => {
                const n = d.noteObj;
                const y = d.y;
                
                let currentX = baseX;
                
                // Kollisionserkennung
                if (Math.abs(y - prevY) <= 6) {
                    currentX = baseX + 13;
                }
                prevY = y;

                // Hilfslinien (Ledger Lines)
                // Diese m√ºssen relativ zu den fixen Linien (40-80) berechnet werden
                if (y >= 90 || y <= 30) {
                    const ledger = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    ledger.setAttribute("x1", currentX - 9); ledger.setAttribute("x2", currentX + 9);
                    let lineY = Math.round(y/10)*10; 
                    if(lineY % 10 !== 0) lineY = y; 
                    ledger.setAttribute("y1", lineY); ledger.setAttribute("y2", lineY); 
                    ledger.setAttribute("class", "staff-line ledger");
                    group.appendChild(ledger);
                }

                // Hals
                const stem = document.createElementNS("http://www.w3.org/2000/svg", "line");
                if (y < 60) { 
                    stem.setAttribute("x1", currentX - 5); stem.setAttribute("x2", currentX - 5);
                    stem.setAttribute("y1", y); stem.setAttribute("y2", y + 28);
                } else { 
                    stem.setAttribute("x1", currentX + 5); stem.setAttribute("x2", currentX + 5);
                    stem.setAttribute("y1", y); stem.setAttribute("y2", y - 28);
                }
                stem.setAttribute("class", "jazz-stem");
                group.appendChild(stem);

                // Kopf
                const noteHead = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
                noteHead.setAttribute("cx", currentX); noteHead.setAttribute("cy", y);
                noteHead.setAttribute("rx", 6.5); noteHead.setAttribute("ry", 4.0);
                noteHead.setAttribute("class", "jazz-note");
                noteHead.setAttribute("transform", `rotate(-20 ${currentX} ${y})`);
                group.appendChild(noteHead);

                // Vorzeichen
                if (n.note.includes("#")) {
                    const sharp = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    sharp.setAttribute("class", "accidental");
                    sharp.setAttribute("x", currentX - 18); sharp.setAttribute("y", y + 6); 
                    sharp.textContent = "‚ôØ";
                    group.appendChild(sharp);
                }
            });

            svg.appendChild(group);
        }




        function drawGuitarChart(noteName, quality) {
            instrumentContainer.innerHTML = '';
            let key = noteName;
            if (quality.includes("m") && !quality.includes("maj")) key += "m";
            else if (quality.includes("maj7")) key += "maj7";
            else if (quality.includes("7")) key += "7";
            key = key.replace(" ", "");
            
            let pattern = guitarChordLibrary[key];
            if (!pattern && enharmonicMap[noteName]) {
                let altKey = key.replace(noteName, enharmonicMap[noteName]);
                pattern = guitarChordLibrary[altKey];
                if(pattern) key = altKey;
            }
            if (!pattern) { 
                if(quality.includes("m")) pattern = guitarChordLibrary[noteName+"m"] || guitarChordLibrary[enharmonicMap[noteName]+"m"];
                else pattern = guitarChordLibrary[noteName] || guitarChordLibrary[enharmonicMap[noteName]];
            }
            if (!pattern) pattern = [-1,-1,-1,-1,-1,-1];

            let minFret = 99;
            pattern.forEach(p => { if(p > 0 && p < minFret) minFret = p; });
            if(minFret === 99) minFret = 1;
            let offset = 0;
            if(minFret > 1) offset = minFret - 1;

            const chart = document.createElement('div');
            chart.className = 'chord-chart';
            const title = document.createElement('div');
            title.className = 'instrument-title'; title.innerHTML = key;
            chart.appendChild(title);

            const grid = document.createElement('div');
            grid.className = offset > 0 ? 'chart-grid fret' : 'chart-grid nut';
            
            if(offset > 0) {
                const flabel = document.createElement('div');
                flabel.className = 'fret-offset-label';
                flabel.innerText = (offset+1) + "fr";
                grid.appendChild(flabel);
            }

            for(let i=1; i<=4; i++) {
                const line = document.createElement('div');
                line.className = 'chart-fret-line'; line.style.top = (i * 14) + "px";
                grid.appendChild(line);
            }

            pattern.forEach((fret, stringIndex) => { 
                const stringDiv = document.createElement('div');
                stringDiv.className = 'chart-string';
                if (fret === -1) {
                    const m = document.createElement('div'); m.className = 'chart-marker'; m.innerText = 'x'; stringDiv.appendChild(m);
                } else if (fret === 0) {
                    const m = document.createElement('div'); m.className = 'chart-marker'; m.innerText = 'o'; stringDiv.appendChild(m);
                } else {
                    const relativeFret = fret - offset;
                    if(relativeFret > 0 && relativeFret <= 5) {
                        const dot = document.createElement('div'); dot.className = 'chart-dot';
                        const baseNoteIdx = guitarBaseStrings[stringIndex];
                        const actualNoteIdx = (baseNoteIdx + fret) % 12;
                        if (notes[actualNoteIdx] === currentRootNoteName) {
                            dot.classList.add('root');
                            dot.style.backgroundColor = '#ff6b6b';
                        }
                        dot.style.top = ((relativeFret * 14) - 7) + "px"; 
                        stringDiv.appendChild(dot);
                    }
                }
                grid.appendChild(stringDiv);
            });
            chart.appendChild(grid);
            instrumentContainer.appendChild(chart);
        }

        function drawPiano(vizNotes, chordLabelFull) {
            instrumentContainer.innerHTML = '';
            const container = document.createElement('div'); container.className = 'piano-container';
            
            const title = document.createElement('div');
            title.className = 'instrument-title'; title.innerHTML = chordLabelFull;
            container.appendChild(title);

            const pianoDiv = document.createElement('div'); pianoDiv.className = 'piano-keys';
            const pattern = ['w','b','w','b','w','w','b','w','b','w','b','w'];
            
            let minMidi = 999;
            vizNotes.forEach(n => {
               let m = (n.octave + 1) * 12 + noteIndexMap[n.note.replace('#','')];
               if(m < minMidi) minMidi = m;
            });
            let startOctave = Math.floor(minMidi / 12) - 1; 

            for(let oct=0; oct<2; oct++) {
                const currentOctave = startOctave + oct;
                pattern.forEach((type, i) => {
                    const key = document.createElement('div');
                    key.className = `key ${type === 'w' ? 'white' : 'black'}`;
                    const noteName = notes[i];
                    const isActive = vizNotes.some(n => n.note === noteName && n.octave === currentOctave);
                    if (isActive) {
                        key.classList.add('active');
                        if (noteName === currentRootNoteName) {
                            key.classList.add('root');
                            key.style.backgroundColor = '#ff6b6b';
                            key.style.borderColor = "#b71c1c";
                        }
                    }
                    pianoDiv.appendChild(key);
                });
            }
            container.appendChild(pianoDiv);
            instrumentContainer.appendChild(container);
        }

        function updateInstrumentDisplay() {
            if (lastPlayedNotes.length > 0) {
                const isGuitar = guitarToggle.checked;
                if (!isGuitar) {
                    drawPiano(currentVizNotes, currentChordLabelForVisualizer.split("|")[1]);
                } else {
                    if(currentChordLabelForVisualizer) {
                        const parts = currentChordLabelForVisualizer.split("|");
                        drawGuitarChart(parts[0], parts[1]);
                    }
                }
            }
        }

        let audioCtx;
        const noteFrequencies = { "C": 261.63, "C#": 277.18, "D": 293.66, "D#": 311.13, "E": 329.63, "F": 349.23, "F#": 369.99, "G": 392.00, "G#": 415.30, "A": 440.00, "A#": 466.16, "H": 493.88 };

        function initAudio() {
            if (!audioCtx) { const AudioContext = window.AudioContext || window.webkitAudioContext; audioCtx = new AudioContext(); }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playTone(freq, type, startTime) {
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            if (type === 'guitar') {
                const filter = audioCtx.createBiquadFilter(); osc.type = 'sawtooth'; osc.frequency.value = freq; filter.type = "lowpass"; filter.frequency.value = 2000; 
                osc.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination); osc.start(startTime);
                gain.gain.setValueAtTime(0, startTime); gain.gain.linearRampToValueAtTime(0.3, startTime + 0.02); gain.gain.exponentialRampToValueAtTime(0.001, startTime + 2.0); 
                filter.frequency.setValueAtTime(3000, startTime); filter.frequency.exponentialRampToValueAtTime(500, startTime + 0.5); osc.stop(startTime + 2.0);
            } else {
                osc.type = 'triangle'; osc.frequency.value = freq; osc.connect(gain); gain.connect(audioCtx.destination); osc.start(startTime);
                gain.gain.setValueAtTime(0, startTime); gain.gain.linearRampToValueAtTime(0.2, startTime + 0.05); gain.gain.exponentialRampToValueAtTime(0.001, startTime + 1.5); osc.stop(startTime + 1.5);
            }
        }


// NEU: H√∂lzernes Knack-Ger√§usch
        function playClickSound() {
            if (!audioCtx) initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            // "H√∂lzerner" Charakter: Sinuswelle mit schnellem Pitch-Drop
            osc.type = 'sine';
            // Startfrequenz 150Hz (tiefes Holz), f√§llt schnell ab
            osc.frequency.setValueAtTime(201, t); 
            osc.frequency.exponentialRampToValueAtTime(111, t + 0.08); 

            // Lautst√§rke-H√ºllkurve: Sehr kurz (perkussiv)
            gain.gain.setValueAtTime(0.3, t); 
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.08); 

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start(t);
            osc.stop(t + 0.1);
        }


        function getGuitarVoicingAudio(chordType) {
            switch(chordType) {
                case "Dur": return [0, 7, 12, 16, 19]; case "Moll": return [0, 7, 12, 15, 19];
                case "maj7": return [0, 11, 16, 19]; case "m7": return [0, 10, 15, 19];
                case "7": return [0, 7, 10, 16]; case "7(b9)": return [0, 7, 10, 13, 16]; 
                default: return [0, 4, 7]; 
            }
        }

        let currentVizNotes = [];
           

        function playChordFromPosition(posData) {
            initAudio(); 
            const isJazz = jazzToggle.checked; 
            const isGuitar = guitarToggle.checked; 
            const isMinor = tonalityToggle.checked;
            const modeData = isMinor ? posData.minor : posData.major;
            
            // Info Bar Update
            const infoBar = document.getElementById('infoBar');
            infoBar.innerHTML = `<div class="info-title" style="color:${modeData.color}">${modeData.roman}</div><div class="info-desc">${modeData.desc}</div>`;

            lastClickedRoman = modeData.roman;
            redrawLines(); 

            // 1. GRUNDTON BESTIMMEN
            let indexAtTop = safeMod(0 - currentStep, 12);
            const keyCenterName = notes[indexAtTop]; 
            
            let semitoneOffset = modeData.interval;
            if (posData.index === 9 || posData.index === 11) semitoneOffset -= 12; 
            
            let absRootIndex = safeMod(notes.indexOf(keyCenterName) + semitoneOffset, 12);
            let absRootName = notes[absRootIndex];
            
            // Chord Label
            const chordLabelSuffix = isJazz ? modeData.jazz.label : modeData.pop.label;
            
            // Anzeige-Label
            let displayLabel = chordLabelSuffix;
            if (chordLabelSuffix === "Dur") displayLabel = absRootName;
            else if (chordLabelSuffix === "Moll") displayLabel = absRootName + "m";
            else if (chordLabelSuffix === "Verm.") displayLabel = absRootName + "¬∞";
            else displayLabel = absRootName + chordLabelSuffix;

            currentChordLabelForVisualizer = `${absRootName}|${displayLabel}`;
            currentRootNoteName = absRootName;

            const now = audioCtx.currentTime;
            const playedNotesInfo = [];
            currentVizNotes = []; 

            // 2. AUDIO & NOTEN BERECHNEN
            if (isGuitar) {
                // --- GITARREN LOGIK ---
                let libSuffix = "";
                
                // MAPPING LOGIK FIX:
                if (chordLabelSuffix === "Moll") {
                    libSuffix = "m"; // Pop Moll -> m
                } else if (chordLabelSuffix === "m7") {
                    libSuffix = "m7"; // Jazz m7 -> m7 (jetzt in Library!)
                } else if (chordLabelSuffix === "Verm." || chordLabelSuffix === "m7b5") {
                    libSuffix = "m"; // Fallback f√ºr Dim (oder m7b5 falls nicht in Lib)
                } else if (chordLabelSuffix === "7(b9)") {
                    libSuffix = "7"; // FIX: 7(b9) -> 7 (Dominantseptakkord statt Dur!)
                } else if (chordLabelSuffix.includes("7")) {
                    libSuffix = chordLabelSuffix; // maj7, 7 etc.
                }

                // Lookup Key bauen (z.B. "Am7")
                let lookupKey = (absRootName + libSuffix).replace(" ", "");
                let pattern = guitarChordLibrary[lookupKey];
                
                // Fallback: Enharmonisch
                if (!pattern && enharmonicMap[absRootName]) {
                    let altRoot = enharmonicMap[absRootName];
                    let altKey = (altRoot + libSuffix).replace(" ", "");
                    pattern = guitarChordLibrary[altKey];
                }
                
                // Fallback: Wenn m7 fehlt, nimm m. Wenn 7 fehlt, nimm Dur.
                if (!pattern) {
                    if (libSuffix.includes("m")) pattern = guitarChordLibrary[absRootName+"m"];
                    else pattern = guitarChordLibrary[absRootName];
                }
                if (!pattern) pattern = [-1,-1,-1,-1,-1,-1];

                const openStringMidis = [40, 45, 50, 55, 59, 64];

                pattern.forEach((fret, stringIndex) => {
                    if (fret !== -1) { 
                        const midiPitch = openStringMidis[stringIndex] + fret;
                        const freq = 440 * Math.pow(2, (midiPitch - 69) / 12);
                        const noteName = notes[midiPitch % 12];
                        const octave = Math.floor(midiPitch / 12) - 1;

                        playTone(freq, 'guitar', now + (stringIndex * 0.04));
                        playedNotesInfo.push({ note: noteName, freq: freq, octave: octave });
                        currentVizNotes.push({ note: noteName, octave: octave });
                    }
                });

            } else {
                // --- PIANO LOGIK (Strikte Terzschichtung) ---
                const intervals = isJazz ? modeData.jazz.ivs : modeData.pop.ivs;
                const c4Midi = 60;
                const rootDistFromC = noteIndexMap[absRootName]; 

                intervals.forEach((interval, i) => {
                    const midiPitch = c4Midi + rootDistFromC + interval;
                    const freq = 440 * Math.pow(2, (midiPitch - 69) / 12);
                    const noteIndex = midiPitch % 12;
                    const noteName = notes[noteIndex];
                    const octave = Math.floor(midiPitch / 12) - 1;

                    playTone(freq, 'piano', now + (i * 0.02));
                    playedNotesInfo.push({ note: noteName, freq: freq, octave: octave });
                    currentVizNotes.push({ note: noteName, octave: octave });
                });
            }
            
            lastPlayedNotes = playedNotesInfo;
            drawNotation(playedNotesInfo);
            updateInstrumentDisplay();
        }






        // --- FILTER FUNCTION FIXED ---
        function clearSearch() {
            songSearch.value = "";
            clearBtn.style.display = 'none';
            document.getElementById('replayArea').innerHTML = ""; 
            currentPlayingSong = null;
            renderProgressions(); 
        }

        function showAllSongs() {
            if(songSearch.value === "") filterSongs();
        }

        // NEU: Hilfsfunktion, um den Namen der Kadenz zu finden
        function getProgressionName(song) {
            // Durchsuche alle Definitionen (Major/Minor, Pop/Jazz)
            for (let tonality in progressions) {
                for (let style in progressions[tonality]) {
                    const match = progressions[tonality][style].find(p => 
                        JSON.stringify(p.seq) === JSON.stringify(song.seq)
                    );
                    if (match) return match.name;
                }
            }
            return "Custom";
        }

function filterSongs() {
            const query = songSearch.value.toLowerCase();
            const list = document.getElementById('progList');
            const clearBtn = document.getElementById('clearBtn');
            const replayArea = document.getElementById('replayArea');
            list.innerHTML = "";

            // X-Button Logik
            if (query.length > 0) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
                if(document.activeElement !== songSearch) {
                    renderProgressions(); 
                    return;
                }
            }

            // FILTER-LOGIK (Erweitert)
            const results = query === "" ? songDatabase : songDatabase.filter(s => {
                // Ermittle den Kadenz-Namen dynamisch f√ºr die Suche
                const progName = getProgressionName(s).toLowerCase();
                
                return s.title.toLowerCase().includes(query) || 
                       (s.interpret && s.interpret.toLowerCase().includes(query)) ||
                       s.key.toLowerCase().includes(query) ||
                       progName.includes(query); // Jetzt wird auch der Kadenz-Name gesucht!
            });
            
            if(results.length === 0) {
                list.innerHTML = `<div style="padding:10px; text-align:center; color:#888;">Keine Songs gefunden.</div>`;
                return;
            }

            replayArea.innerHTML = "";

            results.forEach(song => {
                const btn = document.createElement('div'); btn.className = 'prog-btn';
                
                // Hier nutzen wir die Hilfsfunktion auch f√ºr die Anzeige
                let typeName = getProgressionName(song);

                const interpretDisplay = song.interpret ? song.interpret : "Unbekannt";
                
                btn.innerHTML = `
                    <div class="prog-info">
                        <span class="prog-title">${song.title} <span style="font-weight:normal; font-size:0.85rem; color:#555;">(${interpretDisplay}, ${typeName})</span></span>
                        <span class="prog-steps">Key: ${song.key} : ${song.seq.join(' - ')}</span>
                    </div>
                    <div>‚ñ∂Ô∏è</div>
                `;
                btn.onclick = () => loadAndPlaySong(song, btn);
                list.appendChild(btn);
            });
        }

        async function loadAndPlaySong(song, btn) {
            const isMinor = song.type === 'minor';
            tonalityToggle.checked = isMinor;
            
            const targetIndex = notes.indexOf(song.key); 
            let wheelTargetIndex = targetIndex;
            if(isMinor) {
                wheelTargetIndex = safeMod(targetIndex + 3, 12);
            }
            currentStep = -wheelTargetIndex;
            
            songSearch.value = song.title;
            document.getElementById('progList').innerHTML = ""; 
            document.getElementById('clearBtn').style.display = 'block';

            const replayArea = document.getElementById('replayArea');
            const interpretDisplay = song.interpret ? song.interpret : "";
            replayArea.innerHTML = `
                <div class="replay-card" onclick="loadAndPlaySong(currentPlayingSong, this)">
                    <div class="replay-title">üéµ ${song.title}</div>
                    <div class="replay-hint">${interpretDisplay} ‚Ä¢ Tippen zum erneuten Abspielen</div>
                </div>
            `;
            currentPlayingSong = song;

            updateUI(); 
            setWheelRotation(currentStep * 30); 
            
            await playProgression(song, btn || document.querySelector('.replay-card'));
        }


        function playKeyCenter() {
            if(isSequencerPlaying) return;
            const isMinor = tonalityToggle.checked;
            const targetIndex = isMinor ? 9 : 0;
            const targetPosData = wheelPositions.find(p => p && p.index === targetIndex);
            playChordFromPosition(targetPosData);
            const hub = document.querySelector('.center-hub');
            hub.style.transform = "translate(-50%, -50%) scale(0.9)";
            setTimeout(() => hub.style.transform = "translate(-50%, -50%) scale(1)", 100);
        }

let isDragging = false; 
        let startAngle = 0; 
        let startRotation = 0;
        let lastDragStep = 0; // NEU: Merkt sich den letzten Schritt f√ºr den Sound

        wheelContainer.addEventListener('mousedown', startDrag); window.addEventListener('mousemove', doDrag); window.addEventListener('mouseup', endDrag);
        wheelContainer.addEventListener('touchstart', startDrag, {passive: false}); window.addEventListener('touchmove', doDrag, {passive: false}); window.addEventListener('touchend', endDrag);
        
        function getAngle(x, y) {
            const rect = wheelContainer.getBoundingClientRect(); return Math.atan2(y - (rect.top + rect.height / 2), x - (rect.left + rect.width / 2)) * (180 / Math.PI);
        }
        
        function startDrag(e) {
            if(isSequencerPlaying || e.target.closest('.segment-group') || e.target.closest('.center-hub')) return;
            isDragging = true; 
            const clientX = e.touches ? e.touches[0].clientX : e.clientX; 
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startAngle = getAngle(clientX, clientY); 
            startRotation = currentVisualAngle; // currentVisualAngle muss global definiert sein (siehe unten, falls es fehlt)
            
            // NEU: Initiale Position merken
            lastDragStep = Math.round(startRotation / 30);

            outerWheel.style.transition = 'none'; 
            document.getElementById('connLayer').innerHTML = '<defs><marker id="arrowhead" viewBox="0 0 10 7" markerWidth="4" markerHeight="2.8" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';
        }
        
        // Globale Variable sicherstellen (falls nicht schon vorhanden)
        let currentVisualAngle = 0; 

        function doDrag(e) {
            if (!isDragging) return; 
            e.preventDefault(); 
            const clientX = e.touches ? e.touches[0].clientX : e.clientX; 
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            let delta = getAngle(clientX, clientY) - startAngle; 
            let newAngle = startRotation + delta;
            
            // Rad drehen
            setWheelRotation(newAngle);
            currentVisualAngle = newAngle;

            // NEU: Pr√ºfen, ob wir einen 30-Grad-Sektor √ºberschritten haben
            let currentDragStep = Math.round(newAngle / 30);
            if (currentDragStep !== lastDragStep) {
                playClickSound(); // KLACK!
                lastDragStep = currentDragStep;
            }
        }
        
        function endDrag() {
            if (!isDragging) return; 
            isDragging = false; 
            
            // Einrasten
            const snapAngle = Math.round(currentVisualAngle / 30) * 30; 
            
            // Falls wir beim Loslassen gerade so in einen neuen Sektor rutschen, nochmal klicken
            if (Math.round(snapAngle / 30) !== lastDragStep) {
                playClickSound();
            }

            currentVisualAngle = snapAngle; 
            currentStep = Math.round(snapAngle / 30); 
            
            outerWheel.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)'; 
            setWheelRotation(currentVisualAngle); 
            updateKeyCenter();
        }



        function getCoordinatesForIndex(index, radius) {
            const angleInRad = (index * 30 - 90) * (Math.PI / 180);
            return { x: 180 + radius * Math.cos(angleInRad), y: 180 + radius * Math.sin(angleInRad) };
        }
        function redrawLines() { if (lastClickedRoman) drawConnections(lastClickedRoman); else document.getElementById('connLayer').innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>'; }


 function drawConnections(sourceRoman) {
            const connLayer = document.getElementById('connLayer');
            
            // 1. Wenn Toggle aus, leeren und abbrechen
            if (!pathToggle.checked) { 
                // Leeres Defs-Set, falls ausgeschaltet
                connLayer.innerHTML = '<defs><marker id="arrowhead" viewBox="0 0 10 7" markerWidth="4" markerHeight="2.8" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>'; 
                return; 
            }
            
            // 2. Reset Layer & NEUE PFEIL-DEFINITION
            // √Ñnderung: markerWidth von 10 auf 4 reduziert. Das macht den Pfeil viel kleiner.
            // viewBox hinzugef√ºgt, um das Verh√§ltnis zu wahren.
            connLayer.innerHTML = '<defs><marker id="arrowhead" viewBox="0 0 10 7" markerWidth="4" markerHeight="2.8" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';
            
            const isJazz = jazzToggle.checked; 
            const isMinor = tonalityToggle.checked;
            
            // Alle m√∂glichen Ziele holen (Kopie)
            let targets = [...(probabilityMap[isMinor?'minor':'major'][isJazz?'jazz':'pop'][sourceRoman] || [])];
            
            if (targets.length === 0) return;

            // 3. SORTIEREN: Die wahrscheinlichsten nach oben
            targets.sort((a, b) => b[1] - a[1]);

            // 4. "TOP N" AUSW√ÑHLEN (Basierend auf Slider 1, 2, 3)
            const limit = parseInt(complexitySlider.value);
            const targetsToShow = targets.slice(0, limit);

            // 5. Startposition finden
            const sourceRef = segmentGroups.find(r => (isMinor?r.data.minor:r.data.major).roman === sourceRoman);
            if(!sourceRef) return;
            const startPos = getCoordinatesForIndex(sourceRef.data.index, 85);

            // 6. Zeichnen
            targetsToShow.forEach(target => {
                const targetRoman = target[0];
                const probabilityWeight = target[1]; 

                // Zielposition finden
                const targetRef = segmentGroups.find(r => (isMinor?r.data.minor:r.data.major).roman === targetRoman);
                if(!targetRef) return;
                
                const endPos = getCoordinatesForIndex(targetRef.data.index, 85);
                
                // Pfad zeichnen
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", `M ${startPos.x} ${startPos.y} Q 180 180 ${endPos.x} ${endPos.y}`);
                path.setAttribute("class", "conn-path"); 
                path.setAttribute("stroke", "#ffffff");
                
                // Liniendicke basierend auf Gewichtung
                path.setAttribute("stroke-width", probabilityWeight === 3 ? 5 : (probabilityWeight === 2 ? 2.5 : 1));
                
                // √ÑNDERUNG: Dasharray (gestrichelte Linie) entfernt! 
                // Alle Linien sind jetzt durchgezogen.
                
                // Pfeilspitze anf√ºgen (bei allen Verbindungen, die st√§rker als 1 sind, oder bei allen - wie du magst)
                // Aktuell: Nur wenn Gewicht > 1
                if (probabilityWeight > 1) path.setAttribute("marker-end", "url(#arrowhead)");
                
                connLayer.appendChild(path);
            });
        }


        async function playProgression(progObj, btnElement) {
            if (isSequencerPlaying) return; isSequencerPlaying = true; 
            if(btnElement) btnElement.classList.add('playing'); 
            const isMinor = tonalityToggle.checked;
            for (let roman of progObj.seq) {
                const ref = segmentGroups.find(r => (isMinor ? r.data.minor : r.data.major).roman === roman);
                if (ref) {
                    playChordFromPosition(ref.data);
                    ref.group.classList.add('active'); await wait(1200); ref.group.classList.remove('active');
                }
            }
            isSequencerPlaying = false; 
            if(btnElement) btnElement.classList.remove('playing');
        }
        
        // FIX: Added Example Songs Display & Styles
        function renderProgressions() {
            const isJazz = jazzToggle.checked; const isMinor = tonalityToggle.checked;
            const list = progressions[isMinor?'minor':'major'][isJazz?'jazz':'pop'];
            if(songSearch.value.length >= 1) return;
            
            progList.innerHTML = ''; 
            list.forEach(prog => {
                const btn = document.createElement('div'); btn.className = 'prog-btn';
                // Added third line for Example songs
                btn.innerHTML = `
                    <div class="prog-info">
                        <span class="prog-title">${prog.name}</span>
                        <span class="prog-steps">${prog.seq.join(' ‚Äì ')}</span>
                        <span class="prog-ex">Bsp: ${prog.ex}</span>
                    </div>
                    <div>‚ñ∂Ô∏è</div>`;
                btn.onclick = () => playProgression(prog, btn); progList.appendChild(btn);
            });
        }

        // FIX: Toggle Logic for Slider
        function togglePathLines() {
            redrawLines();
            const slider = document.getElementById('complexitySlider');
            const container = document.getElementById('sliderContainer');
            const isEnabled = pathToggle.checked;
            
            slider.disabled = !isEnabled;
            container.style.opacity = isEnabled ? '1' : '0.4';
        }

        function updateUI() {
            const isMinor = tonalityToggle.checked; const isJazz = jazzToggle.checked;
            if(isMinor) innerWheel.classList.add('minor-mode'); else innerWheel.classList.remove('minor-mode');
            keyDisplay.style.color = isMinor ? '#4682B4' : '#333';
            segmentGroups.forEach(ref => {
                const modeData = isMinor ? ref.data.minor : ref.data.major;
                ref.romanSpan.innerText = modeData.roman; ref.romanSpan.style.color = modeData.color;
                ref.labelSpan.innerText = isJazz ? modeData.jazz.label : modeData.pop.label; ref.labelSpan.style.color = modeData.color;
                ref.iconImg.src = modeData.image; ref.iconImg.alt = modeData.roman;
            });
            updateKeyCenter(); 
            // Fix: Show defaults if search empty
            if(songSearch.value.length < 1) { 
                document.getElementById('replayArea').innerHTML = ""; // Clear Replay
                renderProgressions(); 
            }
            togglePathLines(); // Ensure correct initial state
            drawNotation([]); // Initialisiert leeres System beim Start
        }
        function updateKeyCenter() {
            let indexAtTop = safeMod(0 - currentStep, 12);
            const isMinor = tonalityToggle.checked;
            keyDisplay.innerText = notes[isMinor ? safeMod(indexAtTop + 9, 12) : indexAtTop] + (isMinor ? "m" : "");
        }
        function showStartScreen() {
            const overlay = document.getElementById('startOverlay');
            overlay.style.display = 'flex';
            // Kleiner Timeout f√ºr den Fade-In Effekt
            setTimeout(() => { overlay.style.opacity = '1'; }, 10);
        }
    </script>
</body>
</html>