<!-- Version: v1.41.0 (2025-12-7) -->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harmonie-Rad V41 (Reset Button)</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Gochi+Hand&display=swap" rel="stylesheet">

    <style>
        /* --- BASICS --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Patrick Hand', cursive; display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; margin: 0; background-color: #f4f1ea; overflow-y: auto; 
            user-select: none; -webkit-user-select: none; padding-bottom: 80px;
        }
        h1 { margin: 5px 0; color: #333; font-size: 1.5rem; }

        /* --- INFO BAR --- */
        .info-bar {
            min-height: 50px; margin-bottom: 5px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: #222; color: #fff; width: 96%; max-width: 400px;
            border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 5px 10px;
            text-align: center; line-height: 1.1; border: 1px solid #444; flex-shrink: 0;
        }
        .info-title { font-size: 1.2rem; font-weight: bold; color: #ffeb3b; }
        .info-desc { font-size: 0.9rem; color: #ddd; font-family: sans-serif; letter-spacing: 0.3px; }

        /* --- SETTINGS --- */
        .settings-panel {
            background: #fff; padding: 5px 10px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 5px;
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px; border: 1px solid #ccc; z-index: 100; max-width: 400px; width: 96%; flex-shrink: 0;
        }
        .toggle-group { display: flex; align-items: center; gap: 4px; font-size: 0.9rem; color: #555; }
        .mode-label { display: flex; flex-direction: column; align-items: center; line-height: 0.8; font-size: 0.65rem; }
        .divider { width: 1px; background-color: #ddd; height: 20px; }
        .switch { position: relative; display: inline-block; width: 32px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-switch {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px;
        }
        .slider-switch:before {
            position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider-switch { background-color: #333; }
        input:checked + .slider-switch:before { transform: translateX(14px); }
        #tonalityToggle:checked + .slider-switch { background-color: #1a2a3a; }
        input[type=range] { width: 50px; accent-color: #333; cursor: pointer; }

        /* --- WHEEL CONTAINER --- */
        .wheel-container { 
            position: relative; width: 96vw; height: 96vw; max-width: 380px; max-height: 380px;
            touch-action: none; margin-bottom: 5px; flex-shrink: 0; 
        }
        .connections-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 4; pointer-events: none; }
        .conn-path { fill: none; stroke-linecap: round; opacity: 0; animation: fadeInPath 0.4s forwards; filter: drop-shadow(0 0 2px rgba(0,0,0,0.8)); }
        @keyframes fadeInPath { to { opacity: 0.8; } }

        .disc { position: absolute; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; justify-content: center; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .outer-disc { width: 100%; height: 100%; background-color: #fff; z-index: 1; border: 1px solid #999; cursor: grab; }
        .outer-disc:active { cursor: grabbing; }
        .inner-disc { width: 82%; height: 82%; background-color: #2b2b2b; color: #fff; z-index: 2; border: 2px solid #fff; pointer-events: none; transition: background-color 0.5s ease; }
        .inner-disc.minor-mode { background-color: #1a2a3a; border-color: #a0e6ff; }

        .center-hub {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 18%; height: 18%; 
            background-color: #fff; border-radius: 50%; z-index: 10; border: 3px solid #333; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1); pointer-events: auto; cursor: pointer; transition: transform 0.1s;
        }
        .center-hub:active { transform: translate(-50%, -50%) scale(0.95); }
        .center-label { font-size: 0.7rem; color: #666; pointer-events: none; margin-bottom:-2px;}
        .center-key { font-size: 1.5rem; font-weight: bold; color: #333; line-height: 1; pointer-events: none;}

        .segment-group { position: absolute; width: 40px; height: 50%; top: 0; left: 50%; margin-left: -20px; transform-origin: bottom center; pointer-events: none; z-index: 5; transition: transform 0.1s; }
        .segment-group.active .pos-roman, .segment-group.active .pos-icon { transform: scale(1.3); filter: brightness(2.0) drop-shadow(0 0 8px #fff); transition: all 0.1s ease-out; }
        .counter-rotator { position: absolute; width: 40px; display: flex; justify-content: center; align-items: center; pointer-events: auto; cursor: pointer; transition: transform 0.3s; }
        .outer-segment { position: absolute; width: 50px; height: 50%; top: 0; left: 50%; margin-left: -25px; transform-origin: bottom center; pointer-events: none; }
        .outer-rotator { position: absolute; width: 50px; display: flex; justify-content: center; align-items: center; pointer-events: none; }

        .pos-note { top: 4%; height: 30px; }
        .note-text { font-size: 1.5rem; font-weight: bold; color: #333; }
        .pos-roman { top: 5%; height: 35px; flex-direction: column; }
        .roman-text { font-size: 1.5rem; font-weight: bold; line-height: 1; transition: color 0.3s; }
        .quality-text { font-size: 0.8rem; opacity: 0.9; margin-top: -3px; transition: color 0.3s; }
        .pos-icon { top: 19%; height: 50px; } 
        .icon-img { max-width: 45px; max-height: 45px; width: auto; height: auto; object-fit: contain; display: block; transition: filter 0.3s; }
        .marker { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); z-index: 10; width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent; border-top: 15px solid #d32f2f; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }

        /* --- DASHBOARD --- */
        .dashboard {
            width: 96%; max-width: 400px; background: #fff; border: 1px solid #ccc; border-radius: 10px; margin-bottom: 5px;
            display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); flex-shrink: 0;
        }
        .viz-container { display: flex; height: 110px; } 
        .viz-part { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .viz-part.notation { flex: 0.4; background-color: #fffcf5; }
        .viz-part.instrument { flex: 0.6; }
        .viz-divider { width: 1px; background: #eee; }

        #notationSvg { width: 100%; height: 100%; overflow: visible; }
        .staff-line { stroke: #222; stroke-width: 1.5; stroke-linecap: round; opacity: 0.8; }
        .staff-line.ledger { opacity: 0.6; stroke-width: 1.5; }
        .jazz-note { fill: #111; transform-box: fill-box; transform-origin: center; transform: rotate(-15deg); }
        .jazz-stem { stroke: #111; stroke-width: 2.5; stroke-linecap: round; }
        .clef { font-family: 'Gochi Hand', cursive; font-size: 80px; fill: #111; }
        .accidental { font-family: 'Gochi Hand', cursive; font-size: 20px; fill: #111; font-weight: bold; }
        .octave-marker { font-family: 'Gochi Hand', cursive; font-size: 14px; fill: #444; font-style: italic; }
        .octave-line { stroke: #444; stroke-width: 1; stroke-dasharray: 4,4; }
        .instrument-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 2px; font-family: 'Patrick Hand', cursive; color: #333; }

        .chord-chart { width: 80px; height: 95px; display: flex; flex-direction: column; align-items: center; }
        .chart-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 2px; }
        .chart-grid { position: relative; width: 60px; height: 65px; border-top: 4px solid #222; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; }
        .chart-grid.fret { border-top: 2px solid #222; }
        .chart-string { position: relative; width: 1px; height: 100%; display: flex; justify-content: center; }
        .chart-string::after { content: ''; position: absolute; top: 0; bottom: 0; width: 1px; background: #222; }
        .chart-fret-line { position: absolute; left: 0; right: 0; height: 1px; background: #222; z-index:0; }
        .chart-dot { position: absolute; width: 11px; height: 11px; background: #111; border-radius: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2; }
        .chart-dot.root { background: #d32f2f; }
        .chart-marker { position: absolute; top: -14px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #222; font-weight: bold; }
        .fret-offset-label { position: absolute; top: 0; left: -22px; font-size: 0.9rem; font-weight: bold; }

        .piano-container { display: flex; flex-direction: column; align-items: center; width: 100%; justify-content: center; }
        .piano-keys { display: flex; height: 65px; position: relative; margin-top: 5px; }
        .key { border: 1px solid #555; border-top: none; border-radius: 0 0 3px 3px; position: relative; }
        .key.white { width: 16px; background: #fff; height: 100%; z-index: 1; }
        .key.black { width: 10px; background: #333; height: 60%; margin-left: -5px; margin-right: -5px; z-index: 2; }
        .key.active { background: #fbc02d !important; border-bottom: 3px solid #f57f17; } 
        .key.root { background: #d32f2f !important; border-bottom: 3px solid #b71c1c; } 

        /* PROGRESSION CONTAINER */
        .progression-container { width: 96%; max-width: 400px; padding: 0 5px 20px 5px; display: flex; flex-direction: column; gap: 6px; }
        
        /* SEARCH BAR with RESET BUTTON */
        .search-wrapper { position: relative; width: 100%; margin-bottom: 5px; }
        .search-input {
            width: 100%; padding: 10px 40px 10px 40px; 
            font-family: 'Patrick Hand', cursive; font-size: 1.1rem;
            border: 2px solid #ccc; border-radius: 25px; outline: none;
            background: #fff; transition: all 0.3s;
        }
        .search-input:focus { border-color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; color: #888; }
        
        /* THE X BUTTON */
        .clear-icon {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            font-size: 1.1rem; color: #999; cursor: pointer;
            width: 24px; height: 24px; line-height: 24px; text-align: center;
            border-radius: 50%; background: #eee;
            display: none; /* Hidden by default */
        }
        .clear-icon:hover { background: #ccc; color: #333; }

        .prog-btn {
            background: white; border: 1px solid #ccc; border-radius: 8px; padding: 5px 12px; text-align: left; cursor: pointer; transition: background 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; min-height: 50px;
        }
        .prog-btn:hover { background: #f9f9f9; border-color: #999; }
        .prog-btn.playing { border-color: #333; background: #eee; cursor: wait;}
        .prog-info { display: flex; flex-direction: column; }
        .prog-title { font-weight: bold; font-size: 0.95rem; color: #333; }
        .prog-steps { font-size: 0.8rem; color: #666; font-family: sans-serif; }
    </style>
</head>
<body>
    
    <div id="startOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
        <h1 style="font-size:2.5rem; margin-bottom:10px;">Harmonie-Rad</h1>
        <p style="font-size:1.2rem; color:#666; margin-bottom:30px;">Dein Begleiter f√ºr Musiktheorie.</p>
        <button id="startBtn" style="padding:15px 40px; font-size:1.5rem; background:#333; color:white; border:none; border-radius:50px; cursor:pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
            Starten ‚ñ∂Ô∏è
        </button>
        <p style="font-size:0.8rem; color:#999; margin-top:30px;">(Bitte Stummschalter deaktivieren)</p>
    </div>

    <h1>Harmonie-Rad</h1>

    <div class="info-bar" id="infoBar">
        <div class="info-title">Willkommen!</div>
        <div class="info-desc">W√§hle eine Tonart und klicke auf ein Symbol.</div>
    </div>

    <div class="settings-panel">
        <div class="toggle-group">
            <span class="mode-label">‚òÄ</span>
            <label class="switch"><input type="checkbox" id="tonalityToggle" onchange="updateUI()"><span class="slider-switch"></span></label>
            <span class="mode-label">üåô</span>
        </div>
        <div class="divider"></div>
        <div class="toggle-group">
            <span>Pop</span><label class="switch"><input type="checkbox" id="jazzToggle" onchange="updateUI()"><span class="slider-switch"></span></label><span>Jazz</span>
        </div>
        <div class="divider"></div>
        <div class="toggle-group">
            <span>üéπ</span><label class="switch"><input type="checkbox" id="guitarToggle" onchange="updateInstrumentDisplay()"><span class="slider-switch"></span></label><span>üé∏</span>
        </div>
        <div class="divider"></div>
        <div class="toggle-group">
            <span>‚òä</span><label class="switch"><input type="checkbox" id="pathToggle" checked onclick="redrawLines()"><span class="slider-switch"></span></label>
        </div>
        <div class="threshold-group">
            <input type="range" id="complexitySlider" min="1" max="3" value="2" step="1" oninput="redrawLines()">
        </div>
    </div>

    <div class="wheel-container" id="wheelContainer">
        <div class="marker"></div>
        <svg class="connections-layer" id="connLayer"><defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs></svg>
        <div class="disc outer-disc" id="outerWheel"></div>
        <div class="disc inner-disc" id="innerWheel"></div>
        <div class="center-hub" onclick="playKeyCenter()"><span class="center-label">Tonart</span><span class="center-key" id="keyDisplay">C</span></div>
    </div>

    <div class="dashboard">
        <div class="viz-container">
            <div class="viz-part notation">
                <svg id="notationSvg" viewBox="0 0 160 120">
                    <line x1="10" y1="40" x2="150" y2="40" class="staff-line" />
                    <line x1="10" y1="50" x2="150" y2="50" class="staff-line" />
                    <line x1="10" y1="60" x2="150" y2="60" class="staff-line" />
                    <line x1="10" y1="70" x2="150" y2="70" class="staff-line" />
                    <line x1="10" y1="80" x2="150" y2="80" class="staff-line" />
                    <text x="10" y="78" class="clef">ùÑû</text>
                    <g id="notesGroup"></g> 
                </svg>
            </div>
            <div class="viz-divider"></div>
            <div class="viz-part" id="instrumentContainer"></div>
        </div>
    </div>

    <div class="progression-container">
        <div class="search-wrapper">
            <span class="search-icon">üîç</span>
            <input type="text" id="songSearch" class="search-input" placeholder="Song suchen (z.B. Beatles)..." oninput="filterSongs()">
            <span class="clear-icon" id="clearBtn" onclick="clearSearch()">‚úñ</span>
        </div>
        <div id="progList"></div>
    </div>

    <script>
        function safeMod(n, m) { return ((n % m) + m) % m; }
        function wait(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "H"];
        const enharmonicMap = { "C#": "Db", "D#": "Eb", "F#": "Gb", "G#": "Ab", "A#": "Bb", "Db": "C#", "Eb": "D#", "Gb": "F#", "Ab": "G#", "Bb": "A#" };
        const noteIndexMap = {}; notes.forEach((n,i) => noteIndexMap[n] = i);
        const guitarBaseStrings = [4, 9, 2, 7, 11, 4];

        const guitarChordLibrary = {
            "C": [-1, 3, 2, 0, 1, 0], "Cm": [-1, 3, 5, 5, 4, 3], "Cmaj7": [-1, 3, 2, 0, 0, 0], "C7": [-1, 3, 2, 3, 1, 0],
            "Db": [-1, 4, 6, 6, 6, 4], "Dbm": [-1, 4, 6, 6, 5, 4], "Dbmaj7": [-1, 4, 6, 5, 6, 4], "Db7": [-1, 4, 6, 4, 6, 4],
            "D": [-1, -1, 0, 2, 3, 2], "Dm": [-1, -1, 0, 2, 3, 1], "Dmaj7": [-1, -1, 0, 2, 2, 2], "D7": [-1, -1, 0, 2, 1, 2],
            "Eb": [-1, 6, 8, 8, 8, 6], "Ebm": [-1, 6, 8, 8, 7, 6], "Ebmaj7": [-1, 6, 8, 7, 8, 6], "Eb7": [-1, 6, 8, 6, 8, 6],
            "E": [0, 2, 2, 1, 0, 0], "Em": [0, 2, 2, 0, 0, 0], "Emaj7": [0, 2, 1, 1, 0, 0], "E7": [0, 2, 0, 1, 0, 0],
            "F": [1, 3, 3, 2, 1, 1], "Fm": [1, 3, 3, 1, 1, 1], "Fmaj7": [-1, -1, 3, 2, 1, 0], "F7": [1, 3, 1, 2, 1, 1],
            "Gb": [2, 4, 4, 3, 2, 2], "Gbm": [2, 4, 4, 2, 2, 2], "Gbmaj7": [2, -1, 3, 3, 2, -1], "Gb7": [2, 4, 2, 3, 2, 2],
            "G": [3, 2, 0, 0, 0, 3], "Gm": [3, 5, 5, 3, 3, 3], "Gmaj7": [3, 2, 0, 0, 0, 2], "G7": [3, 2, 0, 0, 0, 1],
            "Ab": [4, 6, 6, 5, 4, 4], "Abm": [4, 6, 6, 4, 4, 4], "Abmaj7": [4, -1, 5, 5, 4, -1], "Ab7": [4, 6, 4, 5, 4, 4],
            "A": [-1, 0, 2, 2, 2, 0], "Am": [-1, 0, 2, 2, 1, 0], "Amaj7": [-1, 0, 2, 1, 2, 0], "A7": [-1, 0, 2, 0, 2, 0],
            "Bb": [-1, 1, 3, 3, 3, 1], "Bbm": [-1, 1, 3, 3, 2, 1], "Bbmaj7": [-1, 1, 3, 2, 3, 1], "Bb7": [-1, 1, 3, 1, 3, 1],
            "H": [-1, 2, 4, 4, 4, 2], "Hm": [-1, 2, 4, 4, 3, 2], "Hmaj7": [-1, 2, 4, 3, 4, 2], "H7": [-1, 2, 1, 2, 0, 2]
        };

        const colorsMajor = { tonic: "#C1E1C1", subdom: "#FDFD96", dom: "#FFB7B2", minor: "#B5EAD7", dim: "#D3D3D3" };
        const colorsMinor = { tonic: "#4682B4", tonicParallel: "#89CFF0", subdom: "#87CEEB", subdomParallel: "#B0E0E6", dom: "#5A9BD4", dim: "#B0C4DE" };

        const wheelPositions = [
            { index: 0, 
              major: { roman: "I", desc: "Zuhause. Der Ruhepol.", emoji: "üè†", image: "haus.png", color: colorsMajor.tonic, interval: 0, jazz: {label: "maj7", ivs:[0,4,7,11]}, pop: {label: "Dur", ivs:[0,4,7]} },
              minor: { roman: "bIII", desc: "Das Ferienhaus (Dur-Parallele). Hell.", emoji: "üè°", image: "ferienhaus.png", color: colorsMinor.tonicParallel, interval: 0, jazz: {label: "maj7", ivs:[0,4,7,11]}, pop: {label: "Dur", ivs:[0,4,7]} } },
            null,
            { index: 2, 
              major: { roman: "II", desc: "Die Br√ºcke zur Spannung (V).", emoji: "üåâ", image: "bruecke.png", color: colorsMajor.minor, interval: 2, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} },
              minor: { roman: "iv", desc: "Kleine Br√ºcke. Zieht zur V.", emoji: "üåâ", image: "bruecke.png", color: colorsMinor.subdom, interval: 2, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} } },
            null,
            { index: 4, 
              major: { roman: "III", desc: "Moll-Dominante. F√ºhrt zur VI.", emoji: "üå≥", image: "bank.png", color: colorsMajor.minor, interval: 4, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} },
              minor: { roman: "V", desc: "Der Vulkan! Will nach Hause (i).", emoji: "üåã", image: "berg_gross.png", color: colorsMinor.dom, interval: 4, jazz: {label: "7(b9)", ivs:[0,4,7,10]}, pop: {label: "Dur", ivs:[0,4,7]} } },
            { index: 5, 
              major: { roman: "IV", desc: "Kleiner Ausflug. Aufbruch.", emoji: "‚õ∞Ô∏è", image: "berg_klein.png", color: colorsMajor.subdom, interval: 5, jazz: {label: "maj7", ivs:[0,4,7,11]}, pop: {label: "Dur", ivs:[0,4,7]} },
              minor: { roman: "bVI", desc: "Dramatischer H√∂hepunkt.", emoji: "‚õ∞Ô∏è", image: "berg_klein.png", color: colorsMinor.subdomParallel, interval: 5, jazz: {label: "maj7", ivs:[0,4,7,11]}, pop: {label: "Dur", ivs:[0,4,7]} } },
            null,
            { index: 7, 
              major: { roman: "V", desc: "Der Vulkan. Maximale Spannung.", emoji: "üåã", image: "berg_gross.png", color: colorsMajor.dom, interval: 7, jazz: {label: "7", ivs:[0,4,7,10]}, pop: {label: "Dur", ivs:[0,4,7]} },
              minor: { roman: "bVII", desc: "Hintert√ºr zum Ferienhaus.", emoji: "üå≥", image: "bank.png", color: colorsMinor.dim, interval: 7, jazz: {label: "7", ivs:[0,4,7,10]}, pop: {label: "Dur", ivs:[0,4,7]} } },
            null,
            { index: 9, 
              major: { roman: "VI", desc: "Moll-Parallele. Etwas traurig.", emoji: "üåâ", image: "bruecke.png", color: colorsMajor.minor, interval: 9, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} },
              minor: { roman: "i", desc: "Moll-Zuhause. Melancholisch.", emoji: "üè†", image: "haus.png", color: colorsMinor.tonic, interval: 9, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} } },
            null,
            { index: 11, 
              major: { roman: "VII", desc: "Die Klippe. Sehr instabil.", emoji: "‚ö°", image: "klippe.png", color: colorsMajor.dim, interval: 11, jazz: {label: "m7b5", ivs:[0,3,6,10]}, pop: {label: "Verm.", ivs:[0,3,6]} },
              minor: { roman: "ii¬∞", desc: "Vorbereiter der Spannung.", emoji: "‚ö°", image: "klippe.png", color: colorsMinor.dim, interval: 11, jazz: {label: "m7b5", ivs:[0,3,6,10]}, pop: {label: "Verm.", ivs:[0,3,6]} } } 
        ];

        const probabilityMap = {
            major: {
                pop: { "I": [["V",3],["IV",3],["VI",2],["II",1]], "II": [["V",3],["IV",2]], "III":[["VI",3],["IV",2]], "IV": [["I",3],["V",3]], "V": [["I",3],["VI",2],["IV",2]], "VI": [["IV",3],["V",2]], "VII":[["I",3]] },
                jazz: { "I": [["VI",3],["IV",2]], "II": [["V",3]], "III":[["VI",3]], "IV": [["I",3],["VII",1]], "V": [["I",3]], "VI": [["II",3]], "VII":[["III",3],["I",1]] }
            },
            minor: {
                pop: { "i": [["V",3],["bVI",3]], "iv": [["V",3],["i",2]], "V": [["i",3],["bVI",2]], "bIII":[["bVI",2],["i",3]], "bVI":[["bVII",2],["V",2]], "bVII":[["bIII",3]], "ii¬∞":[["V",3]] },
                jazz: { "i": [["iv",3],["bVI",2]], "ii¬∞":[["V",3]], "V": [["i",3]], "iv": [["bVII",2],["V",1]], "bVI":[["ii¬∞",3]], "bIII":[["bVI",3]], "bVII":[["bIII",3]] }
            }
        };

        const progressions = {
            major: {
                pop: [ { name: "Pop Klassiker", seq: ["I", "IV", "V", "IV"], ex: "La Bamba / Wild Thing" }, { name: "Axis of Awesome", seq: ["I", "V", "VI", "IV"], ex: "Let It Be" }, { name: "Pop Standard", seq: ["VI", "IV", "I", "V"], ex: "Africa" } ],
                jazz: [ { name: "The Jazz DNA", seq: ["II", "V", "I"], ex: "Satin Doll" }, { name: "Turnaround", seq: ["I", "VI", "II", "V"], ex: "I Got Rhythm" }, { name: "Moll-Kadenz", seq: ["VII", "III", "VI"], ex: "Autumn Leaves" } ]
            },
            minor: {
                pop: [ { name: "Andalusian", seq: ["i", "bVII", "bVI", "V"], ex: "Hit the Road Jack" }, { name: "4-Chord Loop", seq: ["i", "bVI", "bIII", "bVII"], ex: "Zombie" }, { name: "Minor Ballad", seq: ["i", "iv", "V", "i"], ex: "House of Rising Sun" } ],
                jazz: [ { name: "Minor II-V-I", seq: ["ii¬∞", "V", "i"], ex: "Autumn Leaves" }, { name: "Minor Turnaround", seq: ["i", "bVI", "ii¬∞", "V"], ex: "Blue Bossa" }, { name: "Minor Blues", seq: ["i", "iv", "i", "V"], ex: "Mr. P.C." } ]
            }
        };

        const songDatabase = [
            { title: "Let It Be (Beatles)", key: "C", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "No Woman No Cry (Bob Marley)", key: "C", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "I'm Yours (Jason Mraz)", key: "H", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "Don't Stop Believin' (Journey)", key: "E", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "Can You Feel The Love Tonight", key: "F", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "Take Me Home Country Roads", key: "A", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "With or Without You (U2)", key: "D", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "She Will Be Loved (Maroon 5)", key: "C", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "Stand By Me (Ben E. King)", key: "A", type: "major", seq: ["I", "VI", "IV", "V"] },
            { title: "Perfect (Ed Sheeran)", key: "G#", type: "major", seq: ["I", "VI", "IV", "V"] },
            { title: "Every Breath You Take (Police)", key: "G#", type: "major", seq: ["I", "VI", "IV", "V"] },
            { title: "Africa (Toto)", key: "H", type: "major", seq: ["VI", "IV", "I", "V"] },
            { title: "Zombie (Cranberries)", key: "E", type: "minor", seq: ["i", "bVI", "bIII", "bVII"] },
            { title: "Hello (Adele)", key: "F", type: "minor", seq: ["i", "bVI", "bIII", "bVII"] },
            { title: "Apologize (OneRepublic)", key: "C", type: "minor", seq: ["i", "bVI", "bIII", "bVII"] },
            { title: "Love The Way You Lie (Eminem)", key: "G", type: "minor", seq: ["i", "bVI", "bIII", "bVII"] },
            { title: "Hit the Road Jack", key: "G#", type: "minor", seq: ["i", "bVII", "bVI", "V"] },
            { title: "Hotel California (Eagles)", key: "H", type: "minor", seq: ["i", "V", "bVII", "IV", "bVI", "bIII", "iv", "V"] },
            { title: "Autumn Leaves", key: "E", type: "minor", seq: ["ii¬∞", "V", "i", "iv", "bVII", "bIII"] },
            { title: "Fly Me To The Moon", key: "A", type: "minor", seq: ["i", "iv", "bVII", "bIII", "bVI", "ii¬∞", "V"] },
            { title: "Billie Jean (Michael Jackson)", key: "F#", type: "minor", seq: ["i", "iv", "i", "iv"] },
            { title: "All of Me (John Legend)", key: "F", type: "minor", seq: ["i", "bVI", "bIII", "bVII"] },
            { title: "Radioactive (Imagine Dragons)", key: "H", type: "minor", seq: ["i", "bIII", "V", "bVI"] },
            { title: "Counting Stars (OneRepublic)", key: "C#", type: "minor", seq: ["i", "bIII", "V", "bVI"] },
            { title: "Hallelujah (Jeff Buckley)", key: "C", type: "major", seq: ["I", "VI", "I", "VI", "IV", "V"] },
            { title: "Creep (Radiohead)", key: "G", type: "major", seq: ["I", "III", "IV", "IV"] }, 
            { title: "Imagine (John Lennon)", key: "C", type: "major", seq: ["I", "IV", "I", "IV"] },
            { title: "Knockin on Heavens Door", key: "G", type: "major", seq: ["I", "V", "II", "IV"] },
            { title: "La Bamba", key: "C", type: "major", seq: ["I", "IV", "V"] },
            { title: "Twist and Shout", key: "D", type: "major", seq: ["I", "IV", "V"] },
            { title: "Sweet Home Alabama", key: "D", type: "major", seq: ["V", "IV", "I"] },
            { title: "Wonderwall (Oasis)", key: "F#", type: "minor", seq: ["i", "bIII", "bVII", "IV"] },
            { title: "Smells Like Teen Spirit", key: "F", type: "minor", seq: ["i", "iv", "bIII", "bVI"] },
            { title: "Otherside (Red Hot Chili Peppers)", key: "A", type: "minor", seq: ["i", "bVI", "bIII", "bVII"] },
            { title: "Boulevard of Broken Dreams", key: "F", type: "minor", seq: ["i", "bIII", "bVII", "V"] },
            { title: "Sweet Child O' Mine", key: "D", type: "major", seq: ["I", "bVII", "IV", "I"] }, 
            { title: "Blue Bossa", key: "C", type: "minor", seq: ["i", "iv", "ii¬∞", "V"] },
            { title: "So What (Miles Davis)", key: "D", type: "minor", seq: ["i", "i"] }, 
            { title: "Take Five", key: "Eb", type: "minor", seq: ["i", "bV"] },
            { title: "Summertime", key: "A", type: "minor", seq: ["i", "ii¬∞", "V", "i"] },
            { title: "House of the Rising Sun", key: "A", type: "minor", seq: ["i", "bIII", "IV", "bVI"] },
            { title: "Mad World", key: "F", type: "minor", seq: ["i", "bIII", "bVII", "IV"] },
            { title: "Viva La Vida (Coldplay)", key: "Ab", type: "major", seq: ["IV", "V", "I", "VI"] },
            { title: "Clocks (Coldplay)", key: "Eb", type: "major", seq: ["I", "V", "II", "IV"] }, 
            { title: "Hey Jude", key: "F", type: "major", seq: ["I", "V", "V", "I"] },
            { title: "Yesterday", key: "F", type: "major", seq: ["I", "VII", "VI", "IV", "V", "I"] },
            { title: "Despacito", key: "H", type: "minor", seq: ["i", "bVI", "bIII", "bVII"] },
            { title: "Purple Rain", key: "A#", type: "major", seq: ["I", "VI", "V", "IV"] },
            { title: "Halo (Beyonce)", key: "A", type: "major", seq: ["I", "VI", "IV", "V"] },
            { title: "Someone Like You", key: "A", type: "major", seq: ["I", "V", "VI", "IV"] },
            { title: "Rolling in the Deep", key: "C", type: "minor", seq: ["i", "bVII", "bVI", "bVII", "bVI"] },
            { title: "Memories (Maroon 5)", key: "H", type: "major", seq: ["I", "V", "VI", "III", "IV", "I", "IV", "V"] }
        ];

        const outerWheel = document.getElementById('outerWheel');
        const innerWheel = document.getElementById('innerWheel'); 
        const keyDisplay = document.getElementById('keyDisplay');
        const jazzToggle = document.getElementById('jazzToggle');
        const guitarToggle = document.getElementById('guitarToggle');
        const pathToggle = document.getElementById('pathToggle');
        const tonalityToggle = document.getElementById('tonalityToggle'); 
        const complexitySlider = document.getElementById('complexitySlider');
        const wheelContainer = document.getElementById('wheelContainer');
        const progContainer = document.getElementById('progContainer');
        const progList = document.getElementById('progList');
        const connLayer = document.getElementById('connLayer');
        const infoBar = document.getElementById('infoBar');
        const instrumentContainer = document.getElementById('instrumentContainer');
        const notesGroup = document.getElementById('notesGroup');
        const startOverlay = document.getElementById('startOverlay');
        const startBtn = document.getElementById('startBtn');
        const songSearch = document.getElementById('songSearch');
        const clearBtn = document.getElementById('clearBtn');
        
        const counterRotatingElements = [];
        const segmentGroups = []; 
        let currentStep = 0;        
        let isSequencerPlaying = false;
        let lastClickedRoman = null; 
        let lastPlayedNotes = [];
        let currentChordLabelForVisualizer = "";
        let currentRootNoteName = "";

        startBtn.addEventListener('click', async () => {
            initAudio();
            if (audioCtx) {
                try {
                    await audioCtx.resume();
                    const buffer = audioCtx.createBuffer(1, 1, 22050);
                    const source = audioCtx.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioCtx.destination);
                    source.start(0);
                } catch (e) { console.error(e); }
            }
            startOverlay.style.opacity = '0';
            setTimeout(() => { startOverlay.style.display = 'none'; }, 500);
            initWheel();
            setWheelRotation(0);
            updateUI();
        });

        function initWheel() {
            if(outerWheel.children.length > 0) return;
            
            notes.forEach((note, index) => {
                const segment = document.createElement('div');
                segment.className = 'outer-segment'; 
                segment.style.transform = `rotate(${index * 30}deg)`;
                const wrapper = document.createElement('div');
                wrapper.className = 'outer-rotator pos-note';
                wrapper.innerHTML = `<span class="note-text">${note}</span>`;
                segment.appendChild(wrapper);
                outerWheel.appendChild(segment);
            });

            wheelPositions.forEach((posData) => {
                if (posData) {
                    const index = posData.index;
                    const group = document.createElement('div');
                    group.className = 'segment-group';
                    group.style.transform = `rotate(${index * 30}deg)`;
                    group.dataset.index = index; 
                    const refs = { group: group, data: posData };
                    group.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        if(isSequencerPlaying) return; 
                        playChordFromPosition(posData);
                    });
                    const romanWrapper = document.createElement('div');
                    romanWrapper.className = 'counter-rotator pos-roman';
                    const romanSpan = document.createElement('span');
                    romanSpan.className = 'roman-text';
                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'quality-text';
                    romanWrapper.appendChild(romanSpan); romanWrapper.appendChild(labelSpan);
                    group.appendChild(romanWrapper); refs.romanSpan = romanSpan; refs.labelSpan = labelSpan;
                    const iconWrapper = document.createElement('div');
                    iconWrapper.className = 'counter-rotator pos-icon';
                    const iconImg = document.createElement('img');
                    iconImg.className = 'icon-img';
                    iconWrapper.appendChild(iconImg);
                    group.appendChild(iconWrapper); refs.iconImg = iconImg;
                    romanWrapper.style.transform = `rotate(${-index * 30}deg)`;
                    iconWrapper.style.transform = `rotate(${-index * 30}deg)`;
                    innerWheel.appendChild(group);
                    segmentGroups.push(refs);
                }
            });
        }

        function setWheelRotation(angle) {
            outerWheel.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
            document.querySelectorAll('.outer-rotator').forEach((el, i) => {
                el.style.transform = `rotate(${- (i * 30) - angle}deg)`;
            });
        }

        function getMidiPitch(noteObj) {
            const idx = noteIndexMap[noteObj.note.replace('#','')];
            const isSharp = noteObj.note.includes("#");
            return (noteObj.octave + 1) * 12 + idx + (isSharp ? 1 : 0);
        }

        function drawNotation(playedNotes) {
            notesGroup.innerHTML = '';
            
            let avgPitch = playedNotes.reduce((acc, n) => acc + getMidiPitch(n), 0) / playedNotes.length;
            let octaveShift = 0; 
            if(avgPitch < 55) octaveShift = -1; 
            if(avgPitch > 84) octaveShift = 1;

            if (octaveShift !== 0) {
                const markerText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                markerText.setAttribute("class", "octave-marker"); markerText.setAttribute("x", 5);
                const markerLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                markerLine.setAttribute("class", "octave-line"); markerLine.setAttribute("x1", 35); markerLine.setAttribute("x2", 130);
                if (octaveShift === -1) {
                    markerText.textContent = "8vb"; markerText.setAttribute("y", 115);
                    markerLine.setAttribute("y1", 110); markerLine.setAttribute("y2", 110);
                } else {
                    markerText.textContent = "8va"; markerText.setAttribute("y", 15);
                    markerLine.setAttribute("y1", 20); markerLine.setAttribute("y2", 20);
                }
                notesGroup.appendChild(markerText); notesGroup.appendChild(markerLine);
            }

            let xPos = 70;
            let notesToDraw = JSON.parse(JSON.stringify(playedNotes));
            notesToDraw.sort((a,b) => getMidiPitch(a) - getMidiPitch(b));

            notesToDraw.forEach((n, i) => {
                let visualOctave = n.octave - octaveShift;
                let baseVal = noteIndexMap[n.note.replace('#','')]; 
                let octDiff = visualOctave - 4; 
                let y = 90 - (octDiff * 35) - (baseVal * 5); 

                let currentX = xPos;

                if (y >= 90 || y <= 30) {
                    const ledger = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    ledger.setAttribute("x1", currentX - 9); ledger.setAttribute("x2", currentX + 9);
                    let lineY = Math.round(y/10)*10; if(lineY % 10 !== 0) lineY = y; 
                    ledger.setAttribute("y1", lineY); ledger.setAttribute("y2", lineY); 
                    ledger.setAttribute("class", "staff-line ledger");
                    notesGroup.appendChild(ledger);
                }

                const stem = document.createElementNS("http://www.w3.org/2000/svg", "line");
                if (y < 60) { 
                    stem.setAttribute("x1", currentX - 5); stem.setAttribute("x2", currentX - 5);
                    stem.setAttribute("y1", y); stem.setAttribute("y2", y + 28);
                } else { 
                    stem.setAttribute("x1", currentX + 5); stem.setAttribute("x2", currentX + 5);
                    stem.setAttribute("y1", y); stem.setAttribute("y2", y - 28);
                }
                stem.setAttribute("class", "jazz-stem");
                notesGroup.appendChild(stem);

                const noteHead = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
                noteHead.setAttribute("cx", currentX); noteHead.setAttribute("cy", y);
                noteHead.setAttribute("rx", 6.5); noteHead.setAttribute("ry", 4.0);
                noteHead.setAttribute("class", "jazz-note");
                noteHead.setAttribute("transform", `rotate(-20 ${currentX} ${y})`);
                notesGroup.appendChild(noteHead);

                if (n.note.includes("#")) {
                    const sharp = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    sharp.setAttribute("class", "accidental");
                    sharp.setAttribute("x", currentX - 18); sharp.setAttribute("y", y + 6); 
                    sharp.textContent = "‚ôØ";
                    notesGroup.appendChild(sharp);
                }
            });
        }

        function drawGuitarChart(noteName, quality) {
            instrumentContainer.innerHTML = '';
            let key = noteName;
            if (quality.includes("m") && !quality.includes("maj")) key += "m";
            else if (quality.includes("maj7")) key += "maj7";
            else if (quality.includes("7")) key += "7";
            key = key.replace(" ", "");
            
            let pattern = guitarChordLibrary[key];
            if (!pattern && enharmonicMap[noteName]) {
                let altKey = key.replace(noteName, enharmonicMap[noteName]);
                pattern = guitarChordLibrary[altKey];
                if(pattern) key = altKey;
            }
            if (!pattern) { 
                if(quality.includes("m")) pattern = guitarChordLibrary[noteName+"m"] || guitarChordLibrary[enharmonicMap[noteName]+"m"];
                else pattern = guitarChordLibrary[noteName] || guitarChordLibrary[enharmonicMap[noteName]];
            }
            if (!pattern) pattern = [-1,-1,-1,-1,-1,-1];

            let minFret = 99;
            pattern.forEach(p => { if(p > 0 && p < minFret) minFret = p; });
            if(minFret === 99) minFret = 1;
            let offset = 0;
            if(minFret > 1) offset = minFret - 1;

            const chart = document.createElement('div');
            chart.className = 'chord-chart';
            const title = document.createElement('div');
            title.className = 'instrument-title'; title.innerHTML = key;
            chart.appendChild(title);

            const grid = document.createElement('div');
            grid.className = offset > 0 ? 'chart-grid fret' : 'chart-grid nut';
            
            if(offset > 0) {
                const flabel = document.createElement('div');
                flabel.className = 'fret-offset-label';
                flabel.innerText = (offset+1) + "fr";
                grid.appendChild(flabel);
            }

            for(let i=1; i<=4; i++) {
                const line = document.createElement('div');
                line.className = 'chart-fret-line'; line.style.top = (i * 14) + "px";
                grid.appendChild(line);
            }

            pattern.forEach((fret, stringIndex) => { 
                const stringDiv = document.createElement('div');
                stringDiv.className = 'chart-string';
                if (fret === -1) {
                    const m = document.createElement('div'); m.className = 'chart-marker'; m.innerText = 'x'; stringDiv.appendChild(m);
                } else if (fret === 0) {
                    const m = document.createElement('div'); m.className = 'chart-marker'; m.innerText = 'o'; stringDiv.appendChild(m);
                } else {
                    const relativeFret = fret - offset;
                    if(relativeFret > 0 && relativeFret <= 5) {
                        const dot = document.createElement('div'); dot.className = 'chart-dot';
                        const baseNoteIdx = guitarBaseStrings[stringIndex];
                        const actualNoteIdx = (baseNoteIdx + fret) % 12;
                        if (notes[actualNoteIdx] === currentRootNoteName) {
                            dot.classList.add('root');
                        }
                        dot.style.top = ((relativeFret * 14) - 7) + "px"; 
                        stringDiv.appendChild(dot);
                    }
                }
                grid.appendChild(stringDiv);
            });
            chart.appendChild(grid);
            instrumentContainer.appendChild(chart);
        }

        // PIANO
        function drawPiano(vizNotes, chordLabelFull) {
            instrumentContainer.innerHTML = '';
            const container = document.createElement('div'); container.className = 'piano-container';
            
            const title = document.createElement('div');
            title.className = 'instrument-title'; title.innerHTML = chordLabelFull;
            container.appendChild(title);

            const pianoDiv = document.createElement('div'); pianoDiv.className = 'piano-keys';
            const pattern = ['w','b','w','b','w','w','b','w','b','w','b','w'];
            
            let minMidi = 999;
            vizNotes.forEach(n => {
               let m = (n.octave + 1) * 12 + noteIndexMap[n.note.replace('#','')];
               if(m < minMidi) minMidi = m;
            });
            let startOctave = Math.floor(minMidi / 12) - 1; 

            for(let oct=0; oct<2; oct++) {
                const currentOctave = startOctave + oct;
                pattern.forEach((type, i) => {
                    const key = document.createElement('div');
                    key.className = `key ${type === 'w' ? 'white' : 'black'}`;
                    const noteName = notes[i];
                    const isActive = vizNotes.some(n => n.note === noteName && n.octave === currentOctave);
                    if (isActive) {
                        key.classList.add('active');
                        if (noteName === currentRootNoteName) key.classList.add('root');
                    }
                    pianoDiv.appendChild(key);
                });
            }
            container.appendChild(pianoDiv);
            instrumentContainer.appendChild(container);
        }

        function updateInstrumentDisplay() {
            if (lastPlayedNotes.length > 0) {
                const isGuitar = guitarToggle.checked;
                if (!isGuitar) {
                    drawPiano(currentVizNotes, currentChordLabelForVisualizer.split("|")[1]);
                } else {
                    if(currentChordLabelForVisualizer) {
                        const parts = currentChordLabelForVisualizer.split("|");
                        drawGuitarChart(parts[0], parts[1]);
                    }
                }
            }
        }

        let audioCtx;
        const noteFrequencies = { "C": 261.63, "C#": 277.18, "D": 293.66, "D#": 311.13, "E": 329.63, "F": 349.23, "F#": 369.99, "G": 392.00, "G#": 415.30, "A": 440.00, "A#": 466.16, "H": 493.88 };

        function initAudio() {
            if (!audioCtx) { const AudioContext = window.AudioContext || window.webkitAudioContext; audioCtx = new AudioContext(); }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playTone(freq, type, startTime) {
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            if (type === 'guitar') {
                const filter = audioCtx.createBiquadFilter(); osc.type = 'sawtooth'; osc.frequency.value = freq; filter.type = "lowpass"; filter.frequency.value = 2000; 
                osc.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination); osc.start(startTime);
                gain.gain.setValueAtTime(0, startTime); gain.gain.linearRampToValueAtTime(0.3, startTime + 0.02); gain.gain.exponentialRampToValueAtTime(0.001, startTime + 2.0); 
                filter.frequency.setValueAtTime(3000, startTime); filter.frequency.exponentialRampToValueAtTime(500, startTime + 0.5); osc.stop(startTime + 2.0);
            } else {
                osc.type = 'triangle'; osc.frequency.value = freq; osc.connect(gain); gain.connect(audioCtx.destination); osc.start(startTime);
                gain.gain.setValueAtTime(0, startTime); gain.gain.linearRampToValueAtTime(0.2, startTime + 0.05); gain.gain.exponentialRampToValueAtTime(0.001, startTime + 1.5); osc.stop(startTime + 1.5);
            }
        }

        function getGuitarVoicingAudio(chordType) {
            switch(chordType) {
                case "Dur": return [0, 7, 12, 16, 19]; case "Moll": return [0, 7, 12, 15, 19];
                case "maj7": return [0, 11, 16, 19]; case "m7": return [0, 10, 15, 19];
                case "7": return [0, 7, 10, 16]; case "7(b9)": return [0, 7, 10, 13, 16]; 
                default: return [0, 4, 7]; 
            }
        }

        let currentVizNotes = [];

        function playChordFromPosition(posData) {
            initAudio(); 
            const isJazz = jazzToggle.checked; const isGuitar = guitarToggle.checked; const isMinor = tonalityToggle.checked;
            const modeData = isMinor ? posData.minor : posData.major;
            
            const infoBar = document.getElementById('infoBar');
            infoBar.innerHTML = `<div class="info-title" style="color:${modeData.color}">${modeData.roman}</div><div class="info-desc">${modeData.desc}</div>`;

            lastClickedRoman = modeData.roman;
            redrawLines(); 

            let indexAtTop = safeMod(0 - currentStep, 12);
            const rootNoteName = notes[indexAtTop];
            const rootFreq = noteFrequencies[rootNoteName];

            let semitoneOffset = modeData.interval;
            if (posData.index === 9 || posData.index === 11) semitoneOffset -= 12; 
            
            const chordRootFreq = rootFreq * Math.pow(2, semitoneOffset / 12);
            const chordLabel = isJazz ? modeData.jazz.label : modeData.pop.label;
            
            let absRootIndex = safeMod(notes.indexOf(rootNoteName) + semitoneOffset, 12);
            let absRootName = notes[absRootIndex];
            
            let displayLabel = chordLabel;
            if (chordLabel === "Dur") displayLabel = absRootName;
            else if (chordLabel === "Moll") displayLabel = absRootName + "m";
            else if (chordLabel === "Verm.") displayLabel = absRootName + "¬∞";
            else displayLabel = absRootName + chordLabel;

            currentChordLabelForVisualizer = `${absRootName}|${displayLabel}`;
            currentRootNoteName = absRootName;

            let audioIntervals;
            if (isGuitar) audioIntervals = getGuitarVoicingAudio(chordLabel);
            else audioIntervals = isJazz ? modeData.jazz.ivs : modeData.pop.ivs;

            const vizIntervals = isJazz ? modeData.jazz.ivs : modeData.pop.ivs;
            currentVizNotes = [];
            const rootNoteIndex = notes.indexOf(rootNoteName);

            vizIntervals.forEach(interval => {
                 let noteIdx = (rootNoteIndex + semitoneOffset + interval) % 12;
                 let octave = 4 + Math.floor((rootNoteIndex + semitoneOffset + interval) / 12);
                 currentVizNotes.push({ note: notes[safeMod(noteIdx, 12)], octave: octave });
            });

            const now = audioCtx.currentTime;
            const playedNotesInfo = [];

            audioIntervals.forEach((interval, i) => {
                const toneFreq = chordRootFreq * Math.pow(2, interval / 12);
                const strumDelay = isGuitar ? 0.06 : 0.03; 
                playTone(toneFreq, isGuitar ? 'guitar' : 'piano', now + (i * strumDelay));
                
                let absNoteIdx = safeMod(notes.indexOf(rootNoteName) + semitoneOffset + interval, 12);
                let octave = 4 + Math.floor((notes.indexOf(rootNoteName) + semitoneOffset + interval) / 12);
                if (interval > 12) octave++; 
                playedNotesInfo.push({ note: notes[absNoteIdx], freq: toneFreq, octave: octave });
            });
            
            lastPlayedNotes = playedNotesInfo;
            drawNotation(playedNotesInfo);
            updateInstrumentDisplay();
        }

        // --- FILTER FUNCTION ---
        function clearSearch() {
            songSearch.value = "";
            filterSongs();
            clearBtn.style.display = 'none';
        }

        function filterSongs() {
            const query = songSearch.value.toLowerCase();
            const list = document.getElementById('progList');
            const clearBtn = document.getElementById('clearBtn');
            list.innerHTML = "";

            if (query.length > 0) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
                renderProgressions(); // RESET TO DEFAULT
                return;
            }

            const results = songDatabase.filter(s => s.title.toLowerCase().includes(query) || s.key.toLowerCase().includes(query));
            
            if(results.length === 0) {
                list.innerHTML = `<div style="padding:10px; text-align:center; color:#888;">Keine Songs gefunden.</div>`;
                return;
            }

            results.forEach(song => {
                const btn = document.createElement('div'); btn.className = 'prog-btn';
                btn.innerHTML = `<div class="prog-info"><span class="prog-title">${song.title}</span><span class="prog-steps">Key: ${song.key} : ${song.seq.join(' - ')}</span></div><div>‚ñ∂Ô∏è</div>`;
                btn.onclick = () => loadAndPlaySong(song, btn);
                list.appendChild(btn);
            });
        }

        async function loadAndPlaySong(song, btn) {
            const isMinor = song.type === 'minor';
            tonalityToggle.checked = isMinor;
            
            const targetIndex = notes.indexOf(song.key); 
            let wheelTargetIndex = targetIndex;
            if(isMinor) {
                wheelTargetIndex = safeMod(targetIndex + 3, 12);
            }
            currentStep = -wheelTargetIndex;
            
            // Set Value, Clear List, Keep X visible
            songSearch.value = song.title;
            document.getElementById('progList').innerHTML = "";
            document.getElementById('clearBtn').style.display = 'block';

            updateUI(); 
            setWheelRotation(currentStep * 30); 
            
            await playProgression(song, btn);
        }

        // ... REST SAME ...
        function playKeyCenter() {
            if(isSequencerPlaying) return;
            const isMinor = tonalityToggle.checked;
            const targetIndex = isMinor ? 9 : 0;
            const targetPosData = wheelPositions.find(p => p && p.index === targetIndex);
            playChordFromPosition(targetPosData);
            const hub = document.querySelector('.center-hub');
            hub.style.transform = "translate(-50%, -50%) scale(0.9)";
            setTimeout(() => hub.style.transform = "translate(-50%, -50%) scale(1)", 100);
        }
        let isDragging = false; let startAngle = 0; let startRotation = 0;
        wheelContainer.addEventListener('mousedown', startDrag); window.addEventListener('mousemove', doDrag); window.addEventListener('mouseup', endDrag);
        wheelContainer.addEventListener('touchstart', startDrag, {passive: false}); window.addEventListener('touchmove', doDrag, {passive: false}); window.addEventListener('touchend', endDrag);
        function getAngle(x, y) {
            const rect = wheelContainer.getBoundingClientRect(); return Math.atan2(y - (rect.top + rect.height / 2), x - (rect.left + rect.width / 2)) * (180 / Math.PI);
        }
        function startDrag(e) {
            if(isSequencerPlaying || e.target.closest('.segment-group') || e.target.closest('.center-hub')) return;
            isDragging = true; const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startAngle = getAngle(clientX, clientY); startRotation = currentVisualAngle; outerWheel.style.transition = 'none'; 
            document.getElementById('connLayer').innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';
        }
        function doDrag(e) {
            if (!isDragging) return; e.preventDefault(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let delta = getAngle(clientX, clientY) - startAngle; currentVisualAngle = startRotation + delta; setWheelRotation(currentVisualAngle);
        }
        function endDrag() {
            if (!isDragging) return; isDragging = false; const snapAngle = Math.round(currentVisualAngle / 30) * 30; currentVisualAngle = snapAngle; currentStep = Math.round(snapAngle / 30); 
            outerWheel.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)'; setWheelRotation(currentVisualAngle); updateKeyCenter();
        }
        function getCoordinatesForIndex(index, radius) {
            const angleInRad = (index * 30 - 90) * (Math.PI / 180);
            return { x: 180 + radius * Math.cos(angleInRad), y: 180 + radius * Math.sin(angleInRad) };
        }
        function redrawLines() { if (lastClickedRoman) drawConnections(lastClickedRoman); else document.getElementById('connLayer').innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>'; }
        function drawConnections(sourceRoman) {
            const connLayer = document.getElementById('connLayer');
            if (!pathToggle.checked) { connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>'; return; }
            connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';
            const isJazz = jazzToggle.checked; const isMinor = tonalityToggle.checked;
            const targets = probabilityMap[isMinor?'minor':'major'][isJazz?'jazz':'pop'][sourceRoman];
            const complexity = parseInt(complexitySlider.value);
            if (!targets) return;
            const sourceRef = segmentGroups.find(r => (isMinor?r.data.minor:r.data.major).roman === sourceRoman);
            if(!sourceRef) return;
            const startPos = getCoordinatesForIndex(sourceRef.data.index, 85);
            targets.forEach(target => {
                if (complexity === 1 && target[1] < 3) return; if (complexity === 2 && target[1] < 2) return;
                const targetRef = segmentGroups.find(r => (isMinor?r.data.minor:r.data.major).roman === target[0]);
                if(!targetRef) return;
                const endPos = getCoordinatesForIndex(targetRef.data.index, 85);
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", `M ${startPos.x} ${startPos.y} Q 180 180 ${endPos.x} ${endPos.y}`);
                path.setAttribute("class", "conn-path"); path.setAttribute("stroke", "#ffffff");
                path.setAttribute("stroke-width", target[1] === 3 ? 5 : (target[1] === 2 ? 2.5 : 1));
                if (target[1] === 1) path.setAttribute("stroke-dasharray", "5,5");
                if (target[1] > 1) path.setAttribute("marker-end", "url(#arrowhead)");
                connLayer.appendChild(path);
            });
        }
        async function playProgression(progObj, btnElement) {
            if (isSequencerPlaying) return; isSequencerPlaying = true; btnElement.classList.add('playing'); 
            const isMinor = tonalityToggle.checked;
            for (let roman of progObj.seq) {
                const ref = segmentGroups.find(r => (isMinor ? r.data.minor : r.data.major).roman === roman);
                if (ref) {
                    playChordFromPosition(ref.data);
                    ref.group.classList.add('active'); await wait(1200); ref.group.classList.remove('active');
                }
            }
            isSequencerPlaying = false; btnElement.classList.remove('playing');
        }
        function renderProgressions() {
            const isJazz = jazzToggle.checked; const isMinor = tonalityToggle.checked;
            const list = progressions[isMinor?'minor':'major'][isJazz?'jazz':'pop'];
            if(songSearch.value.length >= 1) return; 
            
            progList.innerHTML = ''; 
            list.forEach(prog => {
                const btn = document.createElement('div'); btn.className = 'prog-btn';
                btn.innerHTML = `<div class="prog-info"><span class="prog-title">${prog.name}</span><span class="prog-steps">${prog.seq.join(' ‚Äì ')}</span></div><div>‚ñ∂Ô∏è</div>`;
                btn.onclick = () => playProgression(prog, btn); progList.appendChild(btn);
            });
        }
        function updateUI() {
            const isMinor = tonalityToggle.checked; const isJazz = jazzToggle.checked;
            if(isMinor) innerWheel.classList.add('minor-mode'); else innerWheel.classList.remove('minor-mode');
            keyDisplay.style.color = isMinor ? '#4682B4' : '#333';
            segmentGroups.forEach(ref => {
                const modeData = isMinor ? ref.data.minor : ref.data.major;
                ref.romanSpan.innerText = modeData.roman; ref.romanSpan.style.color = modeData.color;
                ref.labelSpan.innerText = isJazz ? modeData.jazz.label : modeData.pop.label; ref.labelSpan.style.color = modeData.color;
                ref.iconImg.src = modeData.image; ref.iconImg.alt = modeData.roman;
            });
            updateKeyCenter(); 
            if(songSearch.value.length < 1) renderProgressions(); 
            redrawLines();
        }
        function updateKeyCenter() {
            let indexAtTop = safeMod(0 - currentStep, 12);
            const isMinor = tonalityToggle.checked;
            keyDisplay.innerText = notes[isMinor ? safeMod(indexAtTop + 9, 12) : indexAtTop] + (isMinor ? "m" : "");
        }
    </script>
</body>
</html>