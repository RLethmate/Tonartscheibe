<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Improvisations-Helfer V9 (Settings)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

    <style>
        /* --- GRUNDLAGEN --- */
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Patrick Hand', cursive; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f1ea; 
            overflow: hidden; 
            user-select: none;
            -webkit-user-select: none;
            overscroll-behavior: none; 
        }

        h1 { margin-bottom: 5px; color: #333; font-size: 2rem; }
        
        /* --- SETTINGS PANEL --- */
        .settings-panel {
            background: #fff;
            padding: 8px 15px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            border: 1px solid #ccc;
            z-index: 100; 
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 1rem;
            color: #555;
        }

        /* Switch Styling */
        .switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #333; }
        input:checked + .slider:before { transform: translateX(16px); }

        /* --- WHEEL CONTAINER --- */
        .wheel-container {
            position: relative;
            width: 360px; 
            height: 360px;
            touch-action: none; 
            margin-bottom: 10px;
        }

        /* --- SVG LAYER --- */
        .connections-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 4; 
            pointer-events: none; 
        }

        /* Pfad-Styling f√ºr Animation */
        .conn-path {
            fill: none;
            stroke-linecap: round;
            opacity: 0; 
            animation: fadeInPath 0.4s forwards;
        }
        
        @keyframes fadeInPath {
            to { opacity: 0.7; } /* Zieltansparenz */
        }

        /* --- SCHEIBEN --- */
        .disc {
            position: absolute;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); 
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .outer-disc {
            width: 360px;
            height: 360px;
            background-color: #fff;
            z-index: 1;
            border: 2px solid #333;
            cursor: grab; 
        }
        .outer-disc:active { cursor: grabbing; }

        .inner-disc {
            width: 230px; 
            height: 230px;
            background-color: #2b2b2b; 
            color: #fff;
            z-index: 2;
            border: 3px solid #fff;
            pointer-events: none; 
        }

        /* --- MITTE --- */
        .center-hub {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 65px; 
            height: 65px;
            background-color: #fff;
            border-radius: 50%;
            z-index: 10; 
            border: 3px solid #333;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            pointer-events: auto; 
            cursor: pointer;
            transition: transform 0.1s;
        }
        .center-hub:active { transform: translate(-50%, -50%) scale(0.95); }

        .center-label { font-size: 0.8rem; color: #666; line-height: 1; pointer-events: none;}
        .center-key { font-size: 1.6rem; font-weight: bold; color: #d32f2f; line-height: 1; margin-top: 2px; pointer-events: none;}

        /* --- SEGMENTE --- */
        .segment-group {
            position: absolute;
            width: 36px; 
            height: 50%; 
            top: 0;
            left: 50%; 
            margin-left: -18px; 
            transform-origin: bottom center; 
            pointer-events: none; 
            z-index: 5;
            transition: transform 0.1s;
        }
        
        .segment-group.active .pos-roman, 
        .segment-group.active .pos-icon {
            transform: scale(1.3); 
            filter: brightness(1.3) drop-shadow(0 0 5px white); 
            transition: all 0.2s ease-out;
        }

        .segment-group:active .pos-roman, 
        .segment-group:active .pos-icon {
            transform: scale(0.9);
            transition: transform 0.1s;
        }

        .counter-rotator {
            position: absolute;
            width: 36px; 
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto; 
            cursor: pointer;
            transition: transform 0.3s;
        }

        .outer-segment {
            position: absolute;
            width: 60px; height: 50%; top: 0; left: 50%; margin-left: -30px;
            transform-origin: bottom center; pointer-events: none;
        }
        .outer-rotator {
            position: absolute;
            width: 60px;
            display: flex; justify-content: center; align-items: center;
            pointer-events: none;
        }

        .pos-note { top: 12px; height: 35px; }
        .note-text { font-size: 1.6rem; font-weight: bold; color: #333; }

        .pos-roman { top: 6px; height: 30px; flex-direction: column; }
        .roman-text { font-size: 1.2rem; font-weight: bold; line-height: 1; }
        .quality-text { font-size: 0.8rem; opacity: 0.8; margin-top: -2px; }

        .pos-icon { top: 40px; height: 40px; } 
        .icon-img {
            max-width: 32px; max-height: 32px;
            width: auto; height: auto;
            object-fit: contain; display: block;
        }
        .emoji-fallback { font-size: 1.5rem; }

        .marker {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            width: 0; height: 0; 
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-top: 22px solid #d32f2f;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }

        /* --- PROGRESSION LIST --- */
        .progression-container {
            width: 100%;
            max-width: 380px;
            padding: 0 10px 20px 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .prog-btn {
            background: white;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 10px 15px;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prog-btn:active { transform: scale(0.98); }
        .prog-btn:hover { background: #f9f9f9; border-color: #999; }
        .prog-btn.playing { border-color: #333; background: #eee; cursor: wait;}

        .prog-info { display: flex; flex-direction: column; }
        .prog-title { font-weight: bold; font-size: 1rem; color: #333; }
        .prog-steps { font-size: 0.9rem; color: #666; margin-top: 2px; }
        .prog-example { font-size: 0.8rem; color: #888; font-style: italic; margin-top: 2px; }

    </style>
</head>
<body>

    <h1>Harmonie-Rad</h1>

    <div class="settings-panel">
        <div class="toggle-group">
            <span>Pop</span>
            <label class="switch">
                <input type="checkbox" id="jazzToggle" onchange="updateUI()">
                <span class="slider"></span>
            </label>
            <span>Jazz</span>
        </div>
        
        <div class="toggle-group" style="margin-left: 10px; border-left: 1px solid #ddd; padding-left: 10px;">
            <span>üéπ</span>
            <label class="switch">
                <input type="checkbox" id="guitarToggle">
                <span class="slider"></span>
            </label>
            <span>üé∏</span>
        </div>

        <div class="toggle-group" style="margin-left: 10px; border-left: 1px solid #ddd; padding-left: 10px;">
            <span>‚òä</span> <label class="switch">
                <input type="checkbox" id="pathToggle" checked>
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="wheel-container" id="wheelContainer">
        <div class="marker"></div>
        
        <svg class="connections-layer" id="connLayer">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                refX="9" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" />
                </marker>
            </defs>
        </svg>

        <div class="disc outer-disc" id="outerWheel"></div>
        <div class="disc inner-disc" id="innerWheel"></div>
        <div class="center-hub" onclick="playKeyCenter()">
            <span class="center-label">Tonart</span>
            <span class="center-key" id="keyDisplay">C</span>
        </div>
    </div>

    <div class="progression-container" id="progContainer"></div>

    <script>
        // --- HELPER ---
        function safeMod(n, m) { return ((n % m) + m) % m; }
        function wait(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        // --- DATEN ---
        const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "H"];
        
        const colors = {
            tonic: "#C1E1C1", subdom: "#FDFD96", dom: "#FFB7B2", minor: "#B5EAD7", dim: "#D3D3D3"
        };

        const functions = [
            { 
                roman: "I", color: colors.tonic, emoji: "üè†", image: "haus.png", interval: 0,
                jazz: { label: "maj7", ivs: [0, 4, 7, 11] },
                pop:  { label: "Dur",  ivs: [0, 4, 7] }
            }, 
            null,
            { 
                roman: "II", color: colors.minor, emoji: "üåâ", image: "bruecke.png", interval: 2,
                jazz: { label: "m7", ivs: [0, 3, 7, 10] },
                pop:  { label: "Moll", ivs: [0, 3, 7] }
            }, 
            null,
            { 
                roman: "III", color: colors.minor, emoji: "üå≥", image: "bank.png", interval: 4, 
                jazz: { label: "m7", ivs: [0, 3, 7, 10] },
                pop:  { label: "Moll", ivs: [0, 3, 7] }
            }, 
            { 
                roman: "IV", color: colors.subdom, emoji: "‚õ∞Ô∏è", image: "berg_klein.png", interval: 5,
                jazz: { label: "maj7", ivs: [0, 4, 7, 11] },
                pop:  { label: "Dur",  ivs: [0, 4, 7] }
            }, 
            null,
            { 
                roman: "V", color: colors.dom, emoji: "üåã", image: "berg_gross.png", interval: 7,
                jazz: { label: "7",   ivs: [0, 4, 7, 10] },
                pop:  { label: "Dur", ivs: [0, 4, 7] }
            }, 
            null,
            { 
                roman: "VI", color: colors.minor, emoji: "üåâ", image: "bruecke.png", interval: 9,
                jazz: { label: "m7", ivs: [0, 3, 7, 10] },
                pop:  { label: "Moll", ivs: [0, 3, 7] }
            }, 
            null,
            { 
                roman: "VII", color: colors.dim, emoji: "‚ö°", image: "klippe.png", interval: 11,
                jazz: { label: "m7b5", ivs: [0, 3, 6, 10] },
                pop:  { label: "Verm.", ivs: [0, 3, 6] }
            }  
        ];

        // --- STATISTIK ---
        const probabilityMatrix = {
            pop: {
                0:  [[7, 3], [5, 2], [9, 2]], 
                2:  [[7, 3], [5, 2], [0, 1]], 
                4:  [[9, 3], [5, 2]],         
                5:  [[0, 3], [7, 2], [9, 1]], 
                7:  [[0, 3], [9, 2], [5, 2]], 
                9:  [[5, 3], [7, 2], [2, 1]], 
                11: [[0, 3]]                  
            },
            jazz: {
                0:  [[9, 3], [5, 2], [2, 2]], 
                2:  [[7, 3], [0, 1]],         
                4:  [[9, 3], [5, 1]],         
                5:  [[0, 2], [2, 1], [11,1]], 
                7:  [[0, 3], [4, 1]],         
                9:  [[2, 3], [7, 1]],         
                11: [[4, 3], [0, 1]]          
            }
        };

        const progressions = {
            pop: [
                { name: "Axis of Awesome", seq: ["I", "V", "VI", "IV"], ex: "Let It Be, Country Roads" },
                { name: "50s Ballade", seq: ["I", "VI", "IV", "V"], ex: "Stand By Me, Perfect" },
                { name: "Pop Standard", seq: ["VI", "IV", "I", "V"], ex: "Hello (Adele), Africa" }
            ],
            jazz: [
                { name: "The Jazz DNA", seq: ["II", "V", "I"], ex: "Satin Doll, Tune Up" },
                { name: "Jazz Turnaround", seq: ["I", "VI", "II", "V"], ex: "I Got Rhythm, Flintstones" },
                { name: "Moll-Kadenz", seq: ["VII", "III", "VI"], ex: "Autumn Leaves, Blue Bossa" }
            ]
        };

        // --- DOM ---
        const outerWheel = document.getElementById('outerWheel');
        const innerWheel = document.getElementById('innerWheel'); 
        const keyDisplay = document.getElementById('keyDisplay');
        const jazzToggle = document.getElementById('jazzToggle');
        const guitarToggle = document.getElementById('guitarToggle');
        const pathToggle = document.getElementById('pathToggle'); // NEU
        const wheelContainer = document.getElementById('wheelContainer');
        const progContainer = document.getElementById('progContainer');
        const connLayer = document.getElementById('connLayer');
        
        const counterRotatingElements = [];
        const qualityLabels = []; 
        let currentVisualAngle = 0; 
        let currentStep = 0;        
        let isSequencerPlaying = false;

        // --- RENDER ---
        notes.forEach((note, index) => {
            const segment = document.createElement('div');
            segment.className = 'outer-segment'; 
            segment.style.transform = `rotate(${index * 30}deg)`;
            const wrapper = document.createElement('div');
            wrapper.className = 'outer-rotator pos-note';
            wrapper.innerHTML = `<span class="note-text">${note}</span>`;
            segment.appendChild(wrapper);
            outerWheel.appendChild(segment);
            counterRotatingElements.push({ element: wrapper, baseAngle: index * 30 });
        });

        functions.forEach((func, index) => {
            if (func) {
                const group = document.createElement('div');
                group.className = 'segment-group';
                group.style.transform = `rotate(${index * 30}deg)`;
                group.dataset.roman = func.roman; 
                group.dataset.index = index; 

                group.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    if(isSequencerPlaying) return; 
                    playChordFromFunction(func);
                });

                const romanWrapper = document.createElement('div');
                romanWrapper.className = 'counter-rotator pos-roman';
                const labelSpan = document.createElement('span');
                labelSpan.className = 'quality-text';
                labelSpan.style.color = func.color;
                qualityLabels.push({ span: labelSpan, data: func });
                romanWrapper.innerHTML = `<span class="roman-text" style="color:${func.color}">${func.roman}</span>`;
                romanWrapper.appendChild(labelSpan);
                group.appendChild(romanWrapper);
                
                if (func.image || func.emoji) {
                    const iconWrapper = document.createElement('div');
                    iconWrapper.className = 'counter-rotator pos-icon';
                    let iconHtml = func.image 
                        ? `<img src="${func.image}" class="icon-img" alt="${func.roman}">` 
                        : `<span class="emoji-fallback">${func.emoji}</span>`;
                    iconWrapper.innerHTML = iconHtml;
                    group.appendChild(iconWrapper);
                    iconWrapper.style.transform = `rotate(${-index * 30}deg)`;
                }
                romanWrapper.style.transform = `rotate(${-index * 30}deg)`;
                innerWheel.appendChild(group);
            }
        });

        function setWheelRotation(angle) {
            outerWheel.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
            counterRotatingElements.forEach(item => {
                const counterRotation = -item.baseAngle - angle;
                item.element.style.transform = `rotate(${counterRotation}deg)`;
            });
        }

        // --- CONNECTION LINES ---
        
        function getCoordinatesForIndex(index, radius) {
            const angleInRad = (index * 30 - 90) * (Math.PI / 180);
            const cx = 180; 
            const cy = 180;
            return {
                x: cx + radius * Math.cos(angleInRad),
                y: cy + radius * Math.sin(angleInRad)
            };
        }

        function drawConnections(sourceIndex) {
            // Pr√ºfung: Ist der Toggle an?
            if (!pathToggle.checked) {
                connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';
                return;
            }

            // Reset (Defs beibehalten)
            connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';

            const isJazz = jazzToggle.checked;
            const matrix = isJazz ? probabilityMatrix.jazz : probabilityMatrix.pop;
            const targets = matrix[sourceIndex];

            if (!targets) return;

            const startPos = getCoordinatesForIndex(sourceIndex, 85);

            targets.forEach(target => {
                const targetIndex = target[0];
                const weight = target[1]; 
                
                const endPos = getCoordinatesForIndex(targetIndex, 85);

                const ctrlX = 180; 
                const ctrlY = 180;

                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                const d = `M ${startPos.x} ${startPos.y} Q ${ctrlX} ${ctrlY} ${endPos.x} ${endPos.y}`;
                
                path.setAttribute("d", d);
                path.setAttribute("class", "conn-path");
                // Farbe Wei√ü
                path.setAttribute("stroke", "#ffffff");
                
                // Dicke basierend auf Gewichtung (St√§rkerer Kontrast)
                const width = weight === 3 ? 5 : (weight === 2 ? 2.5 : 1);
                path.setAttribute("stroke-width", width);
                
                if (weight === 1) path.setAttribute("stroke-dasharray", "5,5");

                // Pfeilspitze
                if (weight > 1) path.setAttribute("marker-end", "url(#arrowhead)");

                connLayer.appendChild(path);
            });
        }

        // --- AUDIO & LOGIK ---
        // (Identisch zur Vorversion, nur drawConnections Aufruf gepr√ºft)

        let audioCtx;
        const noteFrequencies = {
            "C": 261.63, "C#": 277.18, "D": 293.66, "D#": 311.13, "E": 329.63, "F": 349.23,
            "F#": 369.99, "G": 392.00, "G#": 415.30, "A": 440.00, "A#": 466.16, "H": 493.88
        };

        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playTone(freq, type, startTime) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            if (type === 'guitar') {
                const filter = audioCtx.createBiquadFilter();
                osc.type = 'sawtooth';
                osc.frequency.value = freq;
                filter.type = "lowpass";
                filter.frequency.value = 2000; 
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(startTime);
                
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.3, startTime + 0.02); 
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + 2.0); 
                
                filter.frequency.setValueAtTime(3000, startTime);
                filter.frequency.exponentialRampToValueAtTime(500, startTime + 0.5);
                osc.stop(startTime + 2.0);
            } else {
                osc.type = 'triangle'; 
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(startTime);
                
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.2, startTime + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + 1.5);
                osc.stop(startTime + 1.5);
            }
        }

        function playChordFromFunction(funcData) {
            initAudio(); 
            const isJazz = jazzToggle.checked;
            const isGuitar = guitarToggle.checked;

            const index = functions.indexOf(funcData);
            if(index !== -1) drawConnections(index);

            let indexAtTop = safeMod(0 - currentStep, 12);
            const rootNoteName = notes[indexAtTop];
            const rootFreq = noteFrequencies[rootNoteName];

            let semitoneOffset = funcData.interval;
            if (funcData.roman === "VI" || funcData.roman === "VII") {
                semitoneOffset -= 12; 
            }
            
            const chordRootFreq = rootFreq * Math.pow(2, semitoneOffset / 12);
            const intervals = isJazz ? funcData.jazz.ivs : funcData.pop.ivs;
            const now = audioCtx.currentTime;

            intervals.forEach((interval, i) => {
                const toneFreq = chordRootFreq * Math.pow(2, interval / 12);
                const strumDelay = isGuitar ? 0.05 : 0.03; 
                playTone(toneFreq, isGuitar ? 'guitar' : 'piano', now + (i * strumDelay));
            });
        }

        function playKeyCenter() {
            if(isSequencerPlaying) return;
            connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';
            
            const tonicData = functions[0]; 
            playChordFromFunction(tonicData);
            const hub = document.querySelector('.center-hub');
            hub.style.transform = "translate(-50%, -50%) scale(0.9)";
            setTimeout(() => hub.style.transform = "translate(-50%, -50%) scale(1)", 100);
        }

        // --- DRAG LOGIK ---
        let isDragging = false;
        let startAngle = 0;
        let startRotation = 0;

        wheelContainer.addEventListener('mousedown', startDrag);
        window.addEventListener('mousemove', doDrag);
        window.addEventListener('mouseup', endDrag);
        wheelContainer.addEventListener('touchstart', startDrag, {passive: false});
        window.addEventListener('touchmove', doDrag, {passive: false});
        window.addEventListener('touchend', endDrag);

        function getAngle(x, y) {
            const rect = wheelContainer.getBoundingClientRect();
            return Math.atan2(y - (rect.top + rect.height / 2), x - (rect.left + rect.width / 2)) * (180 / Math.PI);
        }

        function startDrag(e) {
            if(isSequencerPlaying) return;
            if(e.target.closest('.counter-rotator') || e.target.closest('.center-hub')) return;
            isDragging = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startAngle = getAngle(clientX, clientY);
            startRotation = currentVisualAngle;
            outerWheel.style.transition = 'none'; 
            
            // Clear Lines
            connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';
        }

        function doDrag(e) {
            if (!isDragging) return;
            e.preventDefault(); 
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let delta = getAngle(clientX, clientY) - startAngle;
            currentVisualAngle = startRotation + delta;
            setWheelRotation(currentVisualAngle);
        }

        function endDrag() {
            if (!isDragging) return;
            isDragging = false;
            const snapAngle = Math.round(currentVisualAngle / 30) * 30;
            currentVisualAngle = snapAngle;
            currentStep = Math.round(snapAngle / 30); 
            outerWheel.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
            setWheelRotation(currentVisualAngle);
            updateKeyCenter();
        }

        // --- SEQUENCER ---
        async function playProgression(progObj, btnElement) {
            if (isSequencerPlaying) return;
            isSequencerPlaying = true;
            btnElement.classList.add('playing'); 

            connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';

            const sequence = progObj.seq; 

            for (let roman of sequence) {
                const funcData = functions.find(f => f && f.roman === roman);
                const segmentGroup = document.querySelector(`.segment-group[data-roman="${roman}"]`);
                
                if (funcData && segmentGroup) {
                    playChordFromFunction(funcData);
                    segmentGroup.classList.add('active');
                    await wait(1200); 
                    segmentGroup.classList.remove('active');
                }
            }
            isSequencerPlaying = false;
            btnElement.classList.remove('playing');
            
            connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';
        }

        function renderProgressions() {
            const isJazz = jazzToggle.checked;
            const list = isJazz ? progressions.jazz : progressions.pop;
            progContainer.innerHTML = ''; 

            list.forEach(prog => {
                const btn = document.createElement('div');
                btn.className = 'prog-btn';
                btn.innerHTML = `
                    <div class="prog-info">
                        <span class="prog-title">${prog.name}</span>
                        <span class="prog-steps">${prog.seq.join(' ‚Äì ')}</span>
                        <span class="prog-example">Bsp: ${prog.ex}</span>
                    </div>
                    <div>‚ñ∂Ô∏è</div>
                `;
                btn.onclick = () => playProgression(prog, btn);
                progContainer.appendChild(btn);
            });
        }

        function updateUI() {
            const isJazz = jazzToggle.checked;
            qualityLabels.forEach(item => {
                const text = isJazz ? item.data.jazz.label : item.data.pop.label;
                item.span.innerText = text;
            });
            renderProgressions();
            // Clear Lines
            connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';
        }

        function updateKeyCenter() {
            let indexAtTop = safeMod(0 - currentStep, 12);
            const keyNote = notes[indexAtTop];
            keyDisplay.innerText = keyNote;
        }

        // Init
        setWheelRotation(0); 
        updateUI(); 
        updateKeyCenter();

    </script>
</body>
</html>