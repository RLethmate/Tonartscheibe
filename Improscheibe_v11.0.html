<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Improvisations-Helfer V11 (Minor Mode)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

    <style>
        /* --- GRUNDLAGEN --- */
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Patrick Hand', cursive; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f1ea; 
            overflow: hidden; 
            user-select: none;
            -webkit-user-select: none;
            overscroll-behavior: none; 
        }

        h1 { margin-bottom: 5px; color: #333; font-size: 2rem; }
        
        /* --- SETTINGS PANEL --- */
        .settings-panel {
            background: #fff;
            padding: 10px 15px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            gap: 15px;
            border: 1px solid #ccc;
            z-index: 100; 
            max-width: 360px;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 1rem;
            color: #555;
        }

        .divider { width: 1px; background-color: #ddd; height: 20px; }

        /* Switch Styling */
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-switch {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 20px;
        }
        .slider-switch:before {
            position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider-switch { background-color: #333; }
        input:checked + .slider-switch:before { transform: translateX(16px); }
        
        /* Dur/Moll Switch spezielle Farbe */
        #tonalityToggle:checked + .slider-switch { background-color: #1a2a3a; }

        /* Threshold Slider */
        .threshold-group {
            width: 100%; display: flex; align-items: center; justify-content: space-between;
            gap: 10px; font-size: 0.9rem; color: #666; border-top: 1px solid #eee; padding-top: 8px;
        }
        input[type=range] { flex-grow: 1; accent-color: #333; cursor: pointer; }

        /* --- WHEEL CONTAINER --- */
        .wheel-container {
            position: relative; width: 360px; height: 360px; touch-action: none; margin-bottom: 10px;
        }

        /* --- SVG LAYER --- */
        .connections-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 4; pointer-events: none; 
        }
        .conn-path {
            fill: none; stroke-linecap: round; opacity: 0; animation: fadeInPath 0.4s forwards;
        }
        @keyframes fadeInPath { to { opacity: 0.7; } }

        /* --- SCHEIBEN --- */
        .disc {
            position: absolute; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            display: flex; justify-content: center; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .outer-disc {
            width: 360px; height: 360px; background-color: #fff; z-index: 1; border: 2px solid #333; cursor: grab; 
        }
        .outer-disc:active { cursor: grabbing; }

        .inner-disc {
            width: 230px; height: 230px; 
            background-color: #2b2b2b; /* Standard (Dur) */
            color: #fff; z-index: 2; border: 3px solid #fff; pointer-events: none; 
            transition: background-color 0.5s ease; /* Weicher √úbergang f√ºr Nachtmodus */
        }
        /* Nachtmodus Klasse f√ºr die innere Scheibe */
        .inner-disc.minor-mode {
            background-color: #1a2a3a; /* Dunkelblau */
            border-color: #a0e6ff; /* Hellerer Rand */
        }


        /* --- MITTE --- */
        .center-hub {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 65px; height: 65px; background-color: #fff; border-radius: 50%; z-index: 10; 
            border: 3px solid #333; display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1); pointer-events: auto; cursor: pointer; transition: transform 0.1s;
        }
        .center-hub:active { transform: translate(-50%, -50%) scale(0.95); }
        .center-label { font-size: 0.8rem; color: #666; line-height: 1; pointer-events: none;}
        .center-key { font-size: 1.6rem; font-weight: bold; color: #d32f2f; line-height: 1; margin-top: 2px; pointer-events: none;}

        /* --- SEGMENTE --- */
        .segment-group {
            position: absolute; width: 36px; height: 50%; top: 0; left: 50%; margin-left: -18px; 
            transform-origin: bottom center; pointer-events: none; z-index: 5; transition: transform 0.1s;
        }
        .segment-group.active .pos-roman, .segment-group.active .pos-icon {
            transform: scale(1.3); filter: brightness(1.3) drop-shadow(0 0 5px white); transition: all 0.2s ease-out;
        }
        .segment-group:active .pos-roman, .segment-group:active .pos-icon {
            transform: scale(0.9); transition: transform 0.1s;
        }

        .counter-rotator {
            position: absolute; width: 36px; display: flex; justify-content: center; align-items: center;
            pointer-events: auto; cursor: pointer; transition: transform 0.3s;
        }
        .outer-segment {
            position: absolute; width: 60px; height: 50%; top: 0; left: 50%; margin-left: -30px;
            transform-origin: bottom center; pointer-events: none;
        }
        .outer-rotator {
            position: absolute; width: 60px; display: flex; justify-content: center; align-items: center; pointer-events: none;
        }

        .pos-note { top: 12px; height: 35px; }
        .note-text { font-size: 1.6rem; font-weight: bold; color: #333; }

        .pos-roman { top: 6px; height: 30px; flex-direction: column; }
        .roman-text { font-size: 1.2rem; font-weight: bold; line-height: 1; transition: color 0.3s; }
        .quality-text { font-size: 0.8rem; opacity: 0.8; margin-top: -2px; transition: color 0.3s; }

        .pos-icon { top: 40px; height: 40px; } 
        .icon-img {
            max-width: 32px; max-height: 32px; width: auto; height: auto; object-fit: contain; display: block;
            transition: filter 0.3s;
        }
        .emoji-fallback { font-size: 1.5rem; }

        .marker {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%); z-index: 10; width: 0; height: 0; 
            border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 22px solid #d32f2f;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }

        /* --- PROGRESSION LIST --- */
        .progression-container {
            width: 100%; max-width: 380px; padding: 0 10px 20px 10px; display: flex; flex-direction: column; gap: 10px;
        }
        .prog-btn {
            background: white; border: 1px solid #ccc; border-radius: 10px; padding: 10px 15px; text-align: left;
            cursor: pointer; transition: background 0.2s, transform 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .prog-btn:active { transform: scale(0.98); }
        .prog-btn:hover { background: #f9f9f9; border-color: #999; }
        .prog-btn.playing { border-color: #333; background: #eee; cursor: wait;}
        .prog-info { display: flex; flex-direction: column; }
        .prog-title { font-weight: bold; font-size: 1rem; color: #333; }
        .prog-steps { font-size: 0.9rem; color: #666; margin-top: 2px; }
        .prog-example { font-size: 0.8rem; color: #888; font-style: italic; margin-top: 2px; }

    </style>
</head>
<body>

    <h1>Harmonie-Rad</h1>

    <div class="settings-panel">
        <div class="toggle-group">
            <span>‚òÄ</span>
            <label class="switch">
                <input type="checkbox" id="tonalityToggle" onchange="updateUI()">
                <span class="slider-switch"></span>
            </label>
            <span>üåô</span>
        </div>

        <div class="divider"></div>

        <div class="toggle-group">
            <span>Pop</span>
            <label class="switch">
                <input type="checkbox" id="jazzToggle" onchange="updateUI()">
                <span class="slider-switch"></span>
            </label>
            <span>Jazz</span>
        </div>
        
        <div class="divider"></div>

        <div class="toggle-group">
            <span>üéπ</span>
            <label class="switch">
                <input type="checkbox" id="guitarToggle">
                <span class="slider-switch"></span>
            </label>
            <span>üé∏</span>
        </div>

        <div class="divider"></div>

        <div class="toggle-group">
            <span>‚òä</span> 
            <label class="switch">
                <input type="checkbox" id="pathToggle" checked onclick="redrawLines()">
                <span class="slider-switch"></span>
            </label>
        </div>

        <div class="threshold-group">
            <span>Fokus</span>
            <input type="range" id="complexitySlider" min="1" max="3" value="2" step="1" oninput="redrawLines()">
            <span>Entdecker</span>
        </div>
    </div>

    <div class="wheel-container" id="wheelContainer">
        <div class="marker"></div>
        
        <svg class="connections-layer" id="connLayer">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                refX="9" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" />
                </marker>
            </defs>
        </svg>

        <div class="disc outer-disc" id="outerWheel"></div>
        <div class="disc inner-disc" id="innerWheel"></div>
        <div class="center-hub" onclick="playKeyCenter()">
            <span class="center-label">Tonart</span>
            <span class="center-key" id="keyDisplay">C</span>
        </div>
    </div>

    <div class="progression-container" id="progContainer"></div>

    <script>
        // --- HELPER ---
        function safeMod(n, m) { return ((n % m) + m) % m; }
        function wait(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        // --- DATEN ---
        const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "H"];
        
        const colorsMajor = {
            tonic: "#C1E1C1", subdom: "#FDFD96", dom: "#FFB7B2", minor: "#B5EAD7", dim: "#D3D3D3"
        };
        
        // NEU: Blaue Palette f√ºr Moll
        const colorsMinor = {
            tonic: "#4682B4",       // Steel Blue (i)
            tonicParallel: "#89CFF0", // Baby Blue (bIII)
            subdom: "#87CEEB",      // Sky Blue (iv)
            subdomParallel: "#B0E0E6", // Powder Blue (bVI)
            dom: "#5A9BD4",         // Spannung (V)
            dim: "#B0C4DE"          // Light Steel Blue (ii, vii)
        };

        // --- KOMPLEXE DATENSTRUKTUR F√úR DUR & MOLL ---
        // Wir mappen physikalische Positionen (Indices 0-11) auf ihre Rollen in Dur und Moll.
        // interval: Immer relativ zum physikalischen Top (Dur-Root)
        const wheelPositions = [
            { // Index 0 (12 Uhr)
                index: 0,
                major: { roman: "I", emoji: "üè†", image: "haus.png", color: colorsMajor.tonic, interval: 0, jazz: {label: "maj7", ivs:[0,4,7,11]}, pop: {label: "Dur", ivs:[0,4,7]} },
                minor: { roman: "bIII", emoji: "üè°", image: "ferienhaus.png", color: colorsMinor.tonicParallel, interval: 0, jazz: {label: "maj7", ivs:[0,4,7,11]}, pop: {label: "Dur", ivs:[0,4,7]} }
            },
            null,
            { // Index 2
                index: 2,
                major: { roman: "II", emoji: "üåâ", image: "bruecke.png", color: colorsMajor.minor, interval: 2, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} },
                minor: { roman: "iv", emoji: "üåâ", image: "bruecke.png", color: colorsMinor.subdom, interval: 2, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} }
            },
            null,
            { // Index 4 (Bank / Vulkan)
                index: 4,
                major: { roman: "III", emoji: "üå≥", image: "bank.png", color: colorsMajor.minor, interval: 4, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} },
                // WICHTIG: In Moll ist dies die V. Stufe und muss DOMINANT sein (Harmonisch Moll)
                minor: { roman: "V", emoji: "üåã", image: "berg_gross.png", color: colorsMinor.dom, interval: 4, jazz: {label: "7(b9)", ivs:[0,4,7,10]}, pop: {label: "Dur", ivs:[0,4,7]} }
            },
            { // Index 5
                index: 5,
                major: { roman: "IV", emoji: "‚õ∞Ô∏è", image: "berg_klein.png", color: colorsMajor.subdom, interval: 5, jazz: {label: "maj7", ivs:[0,4,7,11]}, pop: {label: "Dur", ivs:[0,4,7]} },
                minor: { roman: "bVI", emoji: "‚õ∞Ô∏è", image: "berg_klein.png", color: colorsMinor.subdomParallel, interval: 5, jazz: {label: "maj7", ivs:[0,4,7,11]}, pop: {label: "Dur", ivs:[0,4,7]} }
            },
            null,
            { // Index 7 (Vulkan / Hintert√ºr)
                index: 7,
                major: { roman: "V", emoji: "üåã", image: "berg_gross.png", color: colorsMajor.dom, interval: 7, jazz: {label: "7", ivs:[0,4,7,10]}, pop: {label: "Dur", ivs:[0,4,7]} },
                minor: { roman: "bVII", emoji: "üö™", image: "bank.png", color: colorsMinor.subdom, interval: 7, jazz: {label: "7", ivs:[0,4,7,10]}, pop: {label: "Dur", ivs:[0,4,7]} } // Bank als Platzhalter
            },
            null,
            { // Index 9 (Br√ºcke / Haus)
                index: 9,
                major: { roman: "VI", emoji: "üåâ", image: "bruecke.png", color: colorsMajor.minor, interval: 9, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} },
                minor: { roman: "i", emoji: "üè†", image: "haus.png", color: colorsMinor.tonic, interval: 9, jazz: {label: "m7", ivs:[0,3,7,10]}, pop: {label: "Moll", ivs:[0,3,7]} }
            },
            null,
            { // Index 11
                index: 11,
                major: { roman: "VII", emoji: "‚ö°", image: "klippe.png", color: colorsMajor.dim, interval: 11, jazz: {label: "m7b5", ivs:[0,3,6,10]}, pop: {label: "Verm.", ivs:[0,3,6]} },
                minor: { roman: "ii¬∞", emoji: "‚ö°", image: "klippe.png", color: colorsMinor.dim, interval: 11, jazz: {label: "m7b5", ivs:[0,3,6,10]}, pop: {label: "Verm.", ivs:[0,3,6]} }
            }  
        ];

        // --- STATISTIK (Muss angepasst werden, da sich Indices verschieben) ---
        // Wir nutzen hier vereinfacht die R√∂mischen Zahlen als Keys f√ºr die Verbindungen.
        // Das ist robuster bei Modus-Wechseln.
        const probabilityMap = {
            pop: {
                "I":  [["V", 3], ["IV", 3], ["VI", 2]],
                "II": [["V", 3], ["IV", 2]],
                "III":[["VI", 3], ["IV", 2]],
                "IV": [["I", 3], ["V", 2]],
                "V":  [["I", 3], ["VI", 2], ["IV", 2]],
                "VI": [["IV", 3], ["V", 2], ["II", 1]],
                "VII":[["I", 3]],
                // Moll-spezifische Pfade
                "i":  [["V", 3], ["iv", 3], ["bIII", 2], ["bVII", 2]],
                "iv": [["V", 3], ["i", 2]],
                "V":  [["i", 3]], // in Moll V -> i
                "bIII":[["bVI", 2], ["iv", 1]],
                "bVI":[["bVII", 2], ["V", 2]],
                "bVII":[["bIII", 3]]
            },
            jazz: {
                "I":  [["VI", 3], ["IV", 2], ["II", 2]],
                "II": [["V", 3]],
                "III":[["VI", 3]],
                "IV": [["I", 2], ["VII", 1]],
                "V":  [["I", 3]],
                "VI": [["II", 3]],
                "VII":[["III", 3]],
                // Moll-Jazz
                "i":  [["iv", 2], ["bVI", 2]],
                "ii¬∞":[["V", 3]],
                "V":  [["i", 3]],
                "iv": [["bVII", 2], ["V", 1]],
                "bVI":[["ii¬∞", 3]],
                "bIII":[["bVI", 2]]
            }
        };

        const progressions = {
            major: {
                pop: [
                    { name: "Axis of Awesome", seq: ["I", "V", "VI", "IV"], ex: "Let It Be" },
                    { name: "50s Ballade", seq: ["I", "VI", "IV", "V"], ex: "Stand By Me" },
                    { name: "Pop Standard", seq: ["VI", "IV", "I", "V"], ex: "Africa" }
                ],
                jazz: [
                    { name: "The Jazz DNA", seq: ["II", "V", "I"], ex: "Satin Doll" },
                    { name: "Turnaround", seq: ["I", "VI", "II", "V"], ex: "I Got Rhythm" },
                    { name: "Backdoor", seq: ["IV", "bVII", "I"], ex: "Lady Bird" }
                ]
            },
            minor: {
                pop: [
                    { name: "Andalusian", seq: ["i", "bVII", "bVI", "V"], ex: "Hit the Road Jack" },
                    { name: "Minor Pop", seq: ["i", "bVI", "bIII", "bVII"], ex: "Wonderwall" }
                ],
                jazz: [
                    { name: "Minor II-V-I", seq: ["ii¬∞", "V", "i"], ex: "Autumn Leaves" },
                    { name: "Minor Turnaround", seq: ["i", "bVI", "ii¬∞", "V"], ex: "Blue Bossa" }
                ]
            }
            
        };

        // --- DOM ---
        const outerWheel = document.getElementById('outerWheel');
        const innerWheel = document.getElementById('innerWheel'); 
        const keyDisplay = document.getElementById('keyDisplay');
        const jazzToggle = document.getElementById('jazzToggle');
        const guitarToggle = document.getElementById('guitarToggle');
        const pathToggle = document.getElementById('pathToggle');
        const tonalityToggle = document.getElementById('tonalityToggle'); // NEU
        const complexitySlider = document.getElementById('complexitySlider');
        const wheelContainer = document.getElementById('wheelContainer');
        const progContainer = document.getElementById('progContainer');
        const connLayer = document.getElementById('connLayer');
        
        const counterRotatingElements = [];
        // Wir speichern nun Referenzen auf die ganzen Gruppen, um sie zu updaten
        const segmentGroups = []; 
        let currentVisualAngle = 0; 
        let currentStep = 0;        
        let isSequencerPlaying = false;
        let lastClickedRoman = null; // Speichern als Roman f√ºr Robustheit

        // --- INITIAL RENDER ---
        notes.forEach((note, index) => {
            const segment = document.createElement('div');
            segment.className = 'outer-segment'; 
            segment.style.transform = `rotate(${index * 30}deg)`;
            const wrapper = document.createElement('div');
            wrapper.className = 'outer-rotator pos-note';
            wrapper.innerHTML = `<span class="note-text">${note}</span>`;
            segment.appendChild(wrapper);
            outerWheel.appendChild(segment);
            counterRotatingElements.push({ element: wrapper, baseAngle: index * 30 });
        });

        wheelPositions.forEach((posData) => {
            if (posData) {
                const index = posData.index;
                const group = document.createElement('div');
                group.className = 'segment-group';
                group.style.transform = `rotate(${index * 30}deg)`;
                group.dataset.index = index; 
                
                // Referenzen f√ºr sp√§tere Updates speichern
                const refs = { group: group, data: posData };

                group.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    if(isSequencerPlaying) return; 
                    playChordFromPosition(posData);
                });

                const romanWrapper = document.createElement('div');
                romanWrapper.className = 'counter-rotator pos-roman';
                const romanSpan = document.createElement('span');
                romanSpan.className = 'roman-text';
                const labelSpan = document.createElement('span');
                labelSpan.className = 'quality-text';
                
                romanWrapper.appendChild(romanSpan);
                romanWrapper.appendChild(labelSpan);
                group.appendChild(romanWrapper);
                
                // Refs speichern
                refs.romanSpan = romanSpan;
                refs.labelSpan = labelSpan;

                const iconWrapper = document.createElement('div');
                iconWrapper.className = 'counter-rotator pos-icon';
                // Platzhalter Image
                const iconImg = document.createElement('img');
                iconImg.className = 'icon-img';
                iconWrapper.appendChild(iconImg);
                group.appendChild(iconWrapper);

                // Ref speichern
                refs.iconImg = iconImg;
                
                romanWrapper.style.transform = `rotate(${-index * 30}deg)`;
                iconWrapper.style.transform = `rotate(${-index * 30}deg)`;
                
                innerWheel.appendChild(group);
                segmentGroups.push(refs);
            }
        });

        function setWheelRotation(angle) {
            outerWheel.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
            counterRotatingElements.forEach(item => {
                const counterRotation = -item.baseAngle - angle;
                item.element.style.transform = `rotate(${counterRotation}deg)`;
            });
        }

        // --- CONNECTION LINES (Updated Logic) ---
        function getCoordinatesForIndex(index, radius) {
            const angleInRad = (index * 30 - 90) * (Math.PI / 180);
            const cx = 180; const cy = 180;
            return { x: cx + radius * Math.cos(angleInRad), y: cy + radius * Math.sin(angleInRad) };
        }

        function redrawLines() {
            if (lastClickedRoman) {
                drawConnections(lastClickedRoman);
            } else {
                connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';
            }
        }

        function drawConnections(sourceRoman) {
            if (!pathToggle.checked) { connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>'; return; }
            connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';

            const isJazz = jazzToggle.checked;
            const isMinor = tonalityToggle.checked;
            const map = isJazz ? probabilityMap.jazz : probabilityMap.pop;
            const targets = map[sourceRoman]; // z.B. [["V", 3], ["IV", 2]]
            const complexity = parseInt(complexitySlider.value);

            if (!targets) return;

            // Finde den Index des Quell-Romans im aktuellen Modus
            const sourceGroupRef = segmentGroups.find(ref => {
                const modeData = isMinor ? ref.data.minor : ref.data.major;
                return modeData.roman === sourceRoman;
            });
            if(!sourceGroupRef) return;
            const sourceIndex = sourceGroupRef.data.index;
            const startPos = getCoordinatesForIndex(sourceIndex, 85);

            targets.forEach(target => {
                const targetRoman = target[0];
                const weight = target[1]; 
                if (complexity === 1 && weight < 3) return;
                if (complexity === 2 && weight < 2) return;

                // Finde Ziel Index
                const targetGroupRef = segmentGroups.find(ref => {
                    const modeData = isMinor ? ref.data.minor : ref.data.major;
                    return modeData.roman === targetRoman;
                });
                if(!targetGroupRef) return;
                const targetIndex = targetGroupRef.data.index;

                const endPos = getCoordinatesForIndex(targetIndex, 85);
                const ctrlX = 180; const ctrlY = 180;
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                const d = `M ${startPos.x} ${startPos.y} Q ${ctrlX} ${ctrlY} ${endPos.x} ${endPos.y}`;
                path.setAttribute("d", d); path.setAttribute("class", "conn-path"); path.setAttribute("stroke", "#ffffff");
                const width = weight === 3 ? 5 : (weight === 2 ? 2.5 : 1);
                path.setAttribute("stroke-width", width);
                if (weight === 1) path.setAttribute("stroke-dasharray", "5,5");
                if (weight > 1) path.setAttribute("marker-end", "url(#arrowhead)");
                connLayer.appendChild(path);
            });
        }

        // --- AUDIO & LOGIK ---
        let audioCtx;
        const noteFrequencies = {
            "C": 261.63, "C#": 277.18, "D": 293.66, "D#": 311.13, "E": 329.63, "F": 349.23,
            "F#": 369.99, "G": 392.00, "G#": 415.30, "A": 440.00, "A#": 466.16, "H": 493.88
        };

        function initAudio() {
            if (!audioCtx) { const AudioContext = window.AudioContext || window.webkitAudioContext; audioCtx = new AudioContext(); }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playTone(freq, type, startTime) {
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            if (type === 'guitar') {
                const filter = audioCtx.createBiquadFilter(); osc.type = 'sawtooth'; osc.frequency.value = freq; filter.type = "lowpass"; filter.frequency.value = 2000; 
                osc.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination); osc.start(startTime);
                gain.gain.setValueAtTime(0, startTime); gain.gain.linearRampToValueAtTime(0.3, startTime + 0.02); gain.gain.exponentialRampToValueAtTime(0.001, startTime + 2.0); 
                filter.frequency.setValueAtTime(3000, startTime); filter.frequency.exponentialRampToValueAtTime(500, startTime + 0.5); osc.stop(startTime + 2.0);
            } else {
                osc.type = 'triangle'; osc.frequency.value = freq; osc.connect(gain); gain.connect(audioCtx.destination); osc.start(startTime);
                gain.gain.setValueAtTime(0, startTime); gain.gain.linearRampToValueAtTime(0.2, startTime + 0.05); gain.gain.exponentialRampToValueAtTime(0.001, startTime + 1.5); osc.stop(startTime + 1.5);
            }
        }

        function playChordFromPosition(posData) {
            initAudio(); 
            const isJazz = jazzToggle.checked;
            const isGuitar = guitarToggle.checked;
            const isMinor = tonalityToggle.checked;

            // W√§hle die richtigen Daten basierend auf Modus
            const modeData = isMinor ? posData.minor : posData.major;

            lastClickedRoman = modeData.roman;
            drawConnections(lastClickedRoman);

            let indexAtTop = safeMod(0 - currentStep, 12);
            const rootNoteName = notes[indexAtTop];
            const rootFreq = noteFrequencies[rootNoteName];

            // Intervall ist immer relativ zum physischen Dur-Root (Top)
            let semitoneOffset = modeData.interval;
            // Transposition f√ºr tiefe Stufen (VI, VII in Dur)
            // In Moll m√ºssen wir schauen, welche physischen Positionen tief sein sollen
            // Index 9 (VI/i) und 11 (VII/ii) sind gute Kandidaten f√ºr Tieferlegung
            if (posData.index === 9 || posData.index === 11) {
                semitoneOffset -= 12; 
            }
            
            const chordRootFreq = rootFreq * Math.pow(2, semitoneOffset / 12);
            const intervals = isJazz ? modeData.jazz.ivs : modeData.pop.ivs;
            const now = audioCtx.currentTime;

            intervals.forEach((interval, i) => {
                const toneFreq = chordRootFreq * Math.pow(2, interval / 12);
                const strumDelay = isGuitar ? 0.05 : 0.03; 
                playTone(toneFreq, isGuitar ? 'guitar' : 'piano', now + (i * strumDelay));
            });
        }

        function playKeyCenter() {
            if(isSequencerPlaying) return;
            connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';
            lastClickedRoman = null;

            // Im Moll Modus ist das Zentrum bei Index 9 (i), im Dur bei Index 0 (I)
            const isMinor = tonalityToggle.checked;
            const targetIndex = isMinor ? 9 : 0;
            const targetPosData = wheelPositions.find(p => p && p.index === targetIndex);

            playChordFromPosition(targetPosData);
            const hub = document.querySelector('.center-hub');
            hub.style.transform = "translate(-50%, -50%) scale(0.9)";
            setTimeout(() => hub.style.transform = "translate(-50%, -50%) scale(1)", 100);
        }

        // --- DRAG LOGIK ---
        let isDragging = false; let startAngle = 0; let startRotation = 0;
        wheelContainer.addEventListener('mousedown', startDrag); window.addEventListener('mousemove', doDrag); window.addEventListener('mouseup', endDrag);
        wheelContainer.addEventListener('touchstart', startDrag, {passive: false}); window.addEventListener('touchmove', doDrag, {passive: false}); window.addEventListener('touchend', endDrag);
        function getAngle(x, y) {
            const rect = wheelContainer.getBoundingClientRect(); return Math.atan2(y - (rect.top + rect.height / 2), x - (rect.left + rect.width / 2)) * (180 / Math.PI);
        }
        function startDrag(e) {
            if(isSequencerPlaying || e.target.closest('.counter-rotator') || e.target.closest('.center-hub')) return;
            isDragging = true; const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startAngle = getAngle(clientX, clientY); startRotation = currentVisualAngle; outerWheel.style.transition = 'none'; 
            connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';
        }
        function doDrag(e) {
            if (!isDragging) return; e.preventDefault(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let delta = getAngle(clientX, clientY) - startAngle; currentVisualAngle = startRotation + delta; setWheelRotation(currentVisualAngle);
        }
        function endDrag() {
            if (!isDragging) return; isDragging = false; const snapAngle = Math.round(currentVisualAngle / 30) * 30; currentVisualAngle = snapAngle; currentStep = Math.round(snapAngle / 30); 
            outerWheel.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)'; setWheelRotation(currentVisualAngle); updateKeyCenter();
        }

        // --- SEQUENCER ---
        async function playProgression(progObj, btnElement) {
            if (isSequencerPlaying) return; isSequencerPlaying = true; btnElement.classList.add('playing'); 
            connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';
            lastClickedRoman = null;
            const isMinor = tonalityToggle.checked;

            for (let roman of progObj.seq) {
                // Finde das Segment anhand des Romans im aktuellen Modus
                const ref = segmentGroups.find(r => {
                    const modeData = isMinor ? r.data.minor : r.data.major;
                    return modeData.roman === roman;
                });
                
                if (ref) {
                    playChordFromPosition(ref.data);
                    ref.group.classList.add('active');
                    await wait(1200); 
                    ref.group.classList.remove('active');
                }
            }
            isSequencerPlaying = false; btnElement.classList.remove('playing');
            connLayer.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" /></marker></defs>';
        }

        function renderProgressions() {
            const isJazz = jazzToggle.checked;
            const isMinor = tonalityToggle.checked;
            const tonalityKey = isMinor ? 'minor' : 'major';
            const styleKey = isJazz ? 'jazz' : 'pop';
            const list = progressions[tonalityKey][styleKey];

            progContainer.innerHTML = ''; 
            list.forEach(prog => {
                const btn = document.createElement('div'); btn.className = 'prog-btn';
                btn.innerHTML = `<div class="prog-info"><span class="prog-title">${prog.name}</span><span class="prog-steps">${prog.seq.join(' ‚Äì ')}</span><span class="prog-example">Bsp: ${prog.ex}</span></div><div>‚ñ∂Ô∏è</div>`;
                btn.onclick = () => playProgression(prog, btn); progContainer.appendChild(btn);
            });
        }

        // --- HAUPT UPDATE FUNKTION ---
        function updateUI() {
            const isJazz = jazzToggle.checked;
            const isMinor = tonalityToggle.checked;

            // 1. Theme Update (Hintergrund)
            if(isMinor) innerWheel.classList.add('minor-mode'); else innerWheel.classList.remove('minor-mode');

            // 2. Segmente Updaten (Inhalt austauschen)
            segmentGroups.forEach(ref => {
                const modeData = isMinor ? ref.data.minor : ref.data.major;
                
                // Text & Farbe
                ref.romanSpan.innerText = modeData.roman;
                ref.romanSpan.style.color = modeData.color;
                ref.labelSpan.innerText = isJazz ? modeData.jazz.label : modeData.pop.label;
                ref.labelSpan.style.color = modeData.color;

                // Icon (Bild tauschen)
                ref.iconImg.src = modeData.image;
                ref.iconImg.alt = modeData.roman;
            });

            // 3. Key Center Update (z.B. "C" zu "Cm")
            updateKeyCenter();

            // 4. Listen und Linien resetten
            renderProgressions();
            redrawLines(); 
        }

        function updateKeyCenter() {
            let indexAtTop = safeMod(0 - currentStep, 12);
            const keyNote = notes[indexAtTop];
            const isMinor = tonalityToggle.checked;
            // H√§nge 'm' an, wenn Moll-Modus
            keyDisplay.innerText = keyNote + (isMinor ? "m" : "");
        }

        // Init
        setWheelRotation(0); 
        updateUI(); 
        // updateKeyCenter wird von updateUI aufgerufen

    </script>
</body>
</html>