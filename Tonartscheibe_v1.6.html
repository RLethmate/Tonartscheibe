<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improvisations-Helfer Real Book</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

    <style>
        /* --- GRUNDLAGEN --- */
        * { box-sizing: border-box; }
        
        body {
            /* Die Jazz-Schriftart */
            font-family: 'Patrick Hand', cursive; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f1ea; /* Papier-Farbe statt Grau */
            overflow: hidden; 
            user-select: none;
            -webkit-user-select: none;
        }

        h1 { margin-bottom: 10px; color: #333; font-size: 2rem; }
        p.subtitle { margin-top: 0; color: #666; font-size: 1.1rem; margin-bottom: 30px;}

        .wheel-container {
            position: relative;
            width: 380px; 
            height: 380px;
        }

        /* --- SCHEIBEN --- */
        .disc {
            position: absolute;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        /* √Ñu√üere Scheibe */
        .outer-disc {
            width: 380px;
            height: 380px;
            background-color: #fff;
            z-index: 1;
            border: 2px solid #333;
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            cursor: pointer; /* Zeigt an, dass man klicken kann */
        }

        /* Innere Scheibe */
        .inner-disc {
            width: 240px; 
            height: 240px;
            background-color: #2b2b2b; /* Fast Schwarz */
            color: #fff;
            z-index: 2;
            border: 3px solid #fff;
            /* Erm√∂glicht Klicks auf Segmente */
            pointer-events: auto; 
        }

        /* --- MITTE (Key Center Anzeige) --- */
        .center-hub {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90px;
            height: 90px;
            background-color: #fff;
            border-radius: 50%;
            z-index: 5;
            border: 3px solid #333;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        .center-label { font-size: 1rem; color: #666; line-height: 1; }
        .center-key { font-size: 2.2rem; font-weight: bold; color: #d32f2f; line-height: 1; }

        /* --- SEGMENTE --- */
        .segment {
            position: absolute;
            width: 60px; 
            height: 50%; 
            top: 0;
            left: 50%; 
            margin-left: -30px; 
            transform-origin: bottom center; 
            /* Damit Klicks registriert werden: */
            pointer-events: auto; 
        }

        /* --- POSITIONIERUNG --- */
        .counter-rotator {
            position: absolute;
            width: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            pointer-events: none; /* Klicks sollen durch den Text auf das Segment gehen */
        }

        .pos-note { top: 10px; height: 40px; }
        .note-text { font-size: 1.8rem; font-weight: bold; color: #333; }

        .pos-roman { top: 8px; height: 35px; flex-direction: column; }
        .roman-text { font-size: 1.3rem; font-weight: bold; line-height: 1; }
        .quality-text { font-size: 0.9rem; opacity: 0.8; margin-top: -2px; }

        .pos-icon { top: 45px; height: 45px; } /* Angepasst f√ºr N√§he */
        
        .icon-img {
            max-width: 40px; max-height: 40px;
            width: auto; height: auto;
            object-fit: contain; display: block;
        }
        .emoji-fallback { font-size: 1.8rem; }

        /* --- MARKIERUNG --- */
        .marker {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            width: 0; height: 0; 
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 25px solid #d32f2f;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }

        /* --- STEUERUNG --- */
        .controls {
            margin-top: 40px;
            display: flex;
            gap: 20px;
        }
        button {
            padding: 10px 30px;
            font-family: 'Patrick Hand', cursive;
            font-size: 1.5rem;
            cursor: pointer;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        button:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <h1>Jazz Harmonie-Rad</h1>
    <p class="subtitle">Klicke auf ein Symbol, um den Akkord zu h√∂ren!</p>

    <div class="wheel-container">
        <div class="marker"></div>
        
        <div class="disc outer-disc" id="outerWheel"></div>
        
        <div class="disc inner-disc" id="innerWheel"></div>

        <div class="center-hub">
            <span class="center-label">Key of</span>
            <span class="center-key" id="keyDisplay">C</span>
        </div>
    </div>

    <div class="controls">
        <button onclick="rotate(-1)">‚¨ÖÔ∏è</button>
        <button onclick="rotate(1)">‚û°Ô∏è</button>
    </div>

    <script>
        // --- DATEN & KONFIGURATION ---
        
        const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "H"];
        
        // Frequenzen f√ºr Audio (Oktave 4)
        const frequencies = {
            "C": 261.63, "C#": 277.18, "D": 293.66, "D#": 311.13, "E": 329.63, "F": 349.23,
            "F#": 369.99, "G": 392.00, "G#": 415.30, "A": 440.00, "A#": 466.16, "H": 493.88
        };

        // Farbpalette (Pastell)
        const colors = {
            tonic: "#C1E1C1",      // Gr√ºn (Home)
            subdom: "#FDFD96",     // Gelb (Unterwegs)
            dom: "#FFB7B2",        // Rot (Spannung)
            minor: "#B5EAD7",      // Blau/T√ºrkis (Moll)
            dim: "#D3D3D3"         // Grau
        };

        const functions = [
            // I (Tonic)
            { roman: "I", quality: "maj7", color: colors.tonic, emoji: "üè†", image: "haus.png", chordType: "maj7" }, 
            null,
            // II (Subdominant Parallel)
            { roman: "II", quality: "m7", color: colors.minor, emoji: "üåâ", image: "bruecke.png", chordType: "m7" }, 
            null,
            // III (Dominant Parallel)
            { roman: "III", quality: "m7", color: colors.minor, emoji: "", image: "", chordType: "m7" }, 
            // IV (Subdominant)
            { roman: "IV", quality: "maj7", color: colors.subdom, emoji: "‚õ∞Ô∏è", image: "berg_klein.png", chordType: "maj7" }, 
            null,
            // V (Dominant)
            { roman: "V", quality: "7", color: colors.dom, emoji: "üåã", image: "berg_gross.png", chordType: "dom7" }, 
            null,
            // VI (Tonic Parallel)
            { roman: "VI", quality: "m7", color: colors.minor, emoji: "üåâ", image: "bruecke.png", chordType: "m7" }, 
            null,
            // VII (Diminished)
            { roman: "VII", quality: "m7b5", color: colors.dim, emoji: "¬∞", image: "", chordType: "dim" }  
        ];

        // --- DOM ELEMENTE ---
        const outerWheel = document.getElementById('outerWheel');
        const innerWheel = document.getElementById('innerWheel');
        const keyDisplay = document.getElementById('keyDisplay');
        const counterRotatingElements = [];
        
        let currentStep = 0; 

        // --- INITIALISIERUNG ---

        // 1. √Ñu√üere Scheibe (Noten)
        notes.forEach((note, index) => {
            const segment = document.createElement('div');
            segment.className = 'segment';
            segment.style.transform = `rotate(${index * 30}deg)`;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'counter-rotator pos-note';
            
            const span = document.createElement('span');
            span.className = 'note-text';
            span.innerText = note;
            
            wrapper.appendChild(span);
            segment.appendChild(wrapper);
            outerWheel.appendChild(segment);
            
            counterRotatingElements.push({ element: wrapper, baseAngle: index * 30 });
        });

        // 2. Innere Scheibe (Funktionen + Farben + Audio Trigger)
        functions.forEach((func, index) => {
            if (func) {
                const segment = document.createElement('div');
                segment.className = 'segment';
                segment.style.transform = `rotate(${index * 30}deg)`;
                
                // Klick-Listener f√ºr Audio
                segment.addEventListener('click', () => {
                    playChordForSegment(index, func.chordType);
                });
                segment.style.cursor = "pointer"; // Zeiger-Maus

                // A) R√∂mische Zahl + Qualit√§t
                const romanWrapper = document.createElement('div');
                romanWrapper.className = 'counter-rotator pos-roman';
                
                // HTML mit Farbe stylen
                romanWrapper.innerHTML = `
                    <span class="roman-text" style="color:${func.color}">${func.roman}</span>
                    <span class="quality-text" style="color:${func.color}">${func.quality}</span>
                `;
                segment.appendChild(romanWrapper);
                counterRotatingElements.push({ element: romanWrapper, baseAngle: index * 30 });

                // B) Icon
                if (func.image || func.emoji) {
                    const iconWrapper = document.createElement('div');
                    iconWrapper.className = 'counter-rotator pos-icon';
                    let iconHtml = '';
                    if (func.image) {
                        // Wir nutzen CSS-Filter, um die Bilder einzuf√§rben (Trick: drop-shadow in Farbe)
                        // Da das kompliziert ist bei externen Bildern, setzen wir hier nur das Bild.
                        // Alternativ: SVG nutzen. Hier belassen wir das Bild original.
                        iconHtml = `<img src="${func.image}" class="icon-img" alt="${func.roman}">`;
                    } else {
                        iconHtml = `<span class="emoji-fallback">${func.emoji}</span>`;
                    }
                    iconWrapper.innerHTML = iconHtml;
                    segment.appendChild(iconWrapper);
                    counterRotatingElements.push({ element: iconWrapper, baseAngle: index * 30 });
                }
                innerWheel.appendChild(segment);
            }
        });

        // --- AUDIO ENGINE (Web Audio API) ---
        let audioCtx;

        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playTone(freq, type = 'triangle', duration = 1) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = type;
            osc.frequency.value = freq;
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start();
            
            // Sanftes Ausklingen
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            
            osc.stop(audioCtx.currentTime + duration);
        }

        function playChordForSegment(segmentIndex, chordType) {
            initAudio(); // Audio starten (Browser Policy)

            // 1. Welche Note liegt gerade auf diesem Segment?
            // Wir m√ºssen die Rotation der √§u√üeren Scheibe ber√ºcksichtigen.
            // Die √§u√üere Scheibe ist um (currentStep * 30) gedreht.
            // Der Index des Segments auf der inneren Scheibe ist fix (z.B. 7 f√ºr V).
            
            // Umgekehrte Logik: Welche Note liegt bei Winkel X?
            // Wir holen den Index im Noten-Array:
            // (SegmentIndex - currentStep) modulo 12
            
            let noteIndex = (segmentIndex - currentStep) % 12;
            if (noteIndex < 0) noteIndex += 12;
            
            const noteName = notes[noteIndex];
            const rootFreq = frequencies[noteName];

            console.log(`Spiele: ${noteName} ${chordType}`);

            // 2. Intervalle berechnen (Halbt√∂ne)
            let intervals = [];
            if (chordType === 'maj7') intervals = [0, 4, 7, 11];
            else if (chordType === 'dom7') intervals = [0, 4, 7, 10];
            else if (chordType === 'm7') intervals = [0, 3, 7, 10];
            else if (chordType === 'dim') intervals = [0, 3, 6, 10]; // m7b5

            // 3. T√∂ne abspielen
            intervals.forEach((semitone, i) => {
                // Frequenzformel: f = f0 * (2^(n/12))
                const freq = rootFreq * Math.pow(2, semitone / 12);
                // Leicht versetzt spielen (Arpeggio-Effekt) f√ºr besseren Klang
                setTimeout(() => playTone(freq, 'triangle', 1.5), i * 50);
            });
        }


        // --- LOGIK & ANIMATION ---

        function rotate(direction) {
            currentStep += direction;
            updateView();
            updateKeyCenter();
        }

        function updateView() {
            const angle = currentStep * 30;
            outerWheel.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
            
            counterRotatingElements.forEach(item => {
                const isOuter = item.element.closest('.outer-disc');
                if (isOuter) {
                     const counterRotation = -item.baseAngle - angle;
                     item.element.style.transform = `rotate(${counterRotation}deg)`;
                } else {
                    item.element.style.transform = `rotate(${-item.baseAngle}deg)`;
                }
            });
        }

        function updateKeyCenter() {
            // Welche Note ist bei 12 Uhr (Index 0)?
            // Wenn wir um +1 drehen (rechts), kommt Note 11 (H) auf die 12 Uhr Position.
            // Index = (0 - currentStep) % 12
            let indexAtTop = (0 - currentStep) % 12;
            if (indexAtTop < 0) indexAtTop += 12;
            
            const keyNote = notes[indexAtTop];
            keyDisplay.innerText = keyNote;
            
            // Animation f√ºr den Text
            keyDisplay.style.opacity = 0;
            setTimeout(() => keyDisplay.style.opacity = 1, 200);
        }

        // Init
        innerWheel.style.transform = `translate(-50%, -50%)`;
        updateView(); 
        updateKeyCenter();

    </script>
</body>
</html>